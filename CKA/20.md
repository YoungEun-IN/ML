## Choosing Kubernetes Infrastructure

ë¡œì»¬ ì„¤ì¹˜ì˜ ê²½ìš°:

- Minikube - VM ë°°í¬, ë‹¨ì¼ ë…¸ë“œ í´ëŸ¬ìŠ¤í„° ìƒì„±
- `kubeadm` - ì¤€ë¹„ëœ VM, ë‹¨ì¼/ë‹¤ì¤‘ ë…¸ë“œ í´ëŸ¬ìŠ¤í„° í•„ìš”

ë‘ ê°€ì§€ ìœ í˜•ì˜ ì†”ë£¨ì…˜:

- í„´í‚¤ ì†”ë£¨ì…˜ - (VM í”„ë¡œë¹„ì €ë‹, VM êµ¬ì„±, í´ëŸ¬ìŠ¤í„° ë°°í¬ìš© ìŠ¤í¬ë¦½íŠ¸, VM ìœ ì§€ ê´€ë¦¬ í•„ìš”). ì˜ˆ: KOPSë¥¼ ì‚¬ìš©í•˜ëŠ” AWSì˜ Kubernetes
- í˜¸ìŠ¤íŒ… ì†”ë£¨ì…˜ - (ê´€ë¦¬í˜• ì†”ë£¨ì…˜) ì˜ˆ: GKE

## Configure High Availability

ì—¬ëŸ¬ ê°œì˜ ì¤‘ë³µ ìŠ¤ì¼€ì¤„ëŸ¬ ë° ê¸°íƒ€ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ êµ¬ì„± ìš”ì†Œë¥¼ ì œê³µí•˜ëŠ” ì—¬ëŸ¬ ë§ˆìŠ¤í„° ë…¸ë“œê°€ ìˆìŠµë‹ˆë‹¤.

### How does it work ?

2ê°œì˜ ë§ˆìŠ¤í„° ë…¸ë“œê°€ ìˆë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ Kubernetes ê°ì²´ `kube-controller-manager` ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.

ì—¬ëŸ¬ ë§ˆìŠ¤í„° ë…¸ë“œë¥¼ ê°–ê¸° ìœ„í•´ `kube-controller-manager`ë¥¼ ì •ì˜í•˜ëŠ” ë™ì•ˆ ëª‡ ê°€ì§€ ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.

```sh
kube-controller-manager --leader-elect true
						--leader-elect-lease-duration 15s
						--leader-elect-renew-deadline 10s
						--leader-elect-retry-period 2s
```

## ETCD in HA

### ì¼ê´€ì„±ì„ ì–´ë–»ê²Œ ìœ ì§€í•©ë‹ˆê¹Œ?

3ê°œì˜ ETCD ë³µì œë³¸ì´ ì‹¤í–‰ ì¤‘ì´ê³  ì¼ë¶€ ë°ì´í„°ë¥¼ ì‘ì„±í•˜ë ¤ê³  í•œë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì¼ê´€ì„±ì„ ë³´ì¥í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?

ëª¨ë“  ë³µì œë³¸ì´ ë°ì´í„° ì“°ê¸°ë¥¼ ë‹´ë‹¹í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì¸ìŠ¤í„´ìŠ¤ ì¤‘ 1ê°œëŠ” ë¦¬ë”ë¡œ ì„ íƒë˜ê³  ë‚˜ë¨¸ì§€ëŠ” íŒ”ë¡œì›Œê°€ ë©ë‹ˆë‹¤. ë¦¬ë”ë§Œ ì“°ê¸°ë¥¼ ì²˜ë¦¬í•˜ê³  ë‹¤ë¥¸ ë³µì œë³¸ì— ë™ì¼í•œ ë°ì´í„°ê°€ ê¸°ë¡ë˜ë„ë¡ í•©ë‹ˆë‹¤.

*ëŒ€ë¶€ë¶„ì˜ ë³µì œë³¸ì—ì„œ ë°ì´í„° ë³µì œê°€ ë°œìƒí•˜ë©´ ì“°ê¸°ê°€ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.*

#### How is leader elected ?

ETCD ë¦¬ë” ì„ ì¶œ í”„ë¡œí† ì½œì„ RAFTë¼ê³  í•©ë‹ˆë‹¤. ë¬´ì‘ìœ„ íƒ€ì´ë¨¸ëŠ” ETCDì˜ 3ê°œ ë³µì œë³¸ ëª¨ë‘ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/etcd-1.svg?raw=true)

ì¸ìŠ¤í„´ìŠ¤ê°€ ë¨¼ì € ì‹œê°„ ì´ˆê³¼ë˜ë©´ ë¦¬ë” ì—­í• ì„ ë§¡ë„ë¡ ë‹¤ë¥¸ ë‘ ì¸ìŠ¤í„´ìŠ¤ì— ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/etcd-2.svg?raw=true)

ìš”ì²­ì´ ìŠ¹ì¸ë˜ë©´ ìš”ì²­ ì¸ìŠ¤í„´ìŠ¤ê°€ ë¦¬ë”ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/etcd-3.svg?raw=true)

ì—¬ê¸°ì—ì„œ ì•Œ ìˆ˜ ìˆë“¯ì´ 'R2'ê°€ ë¦¬ë” ì—­í• ì„ í•©ë‹ˆë‹¤. ë˜í•œ 'R2'ëŠ” ê³„ì†í•´ì„œ ë¦¬ë”ì„ì„ ë‹¤ë¥¸ ë…¸ë“œì— ì§€ì†ì ìœ¼ë¡œ ì•Œë¦½ë‹ˆë‹¤.
ì–´ë–¤ ì´ìœ ë¡œ 'R2'ê°€ ë™ì¼í•œ ê²ƒì„ ë³´ë‚´ì§€ ì•Šìœ¼ë©´ ë‚˜ë¨¸ì§€ ë³µì œë³¸, ì¦‰ 'R1'ê³¼ 'R3' ì‚¬ì´ì—ì„œ ì„ íƒ í”„ë¡œì„¸ìŠ¤ê°€ ë°˜ë³µë©ë‹ˆë‹¤.

#### ì“°ê¸°ëŠ” ì–´ë–»ê²Œ ì „íŒŒë©ë‹ˆê¹Œ?

ê·¸ëŸ¬ë‚˜ íŒ”ë¡œì›Œ 2ëª… ì¤‘ 1ëª…ì´ ë°ì´í„° ë³µì œì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ë³µì œë³¸ ìì²´ê°€ ë‹¤ìš´ëœ ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ ë©ë‹ˆê¹Œ?

> *ëŒ€ë¶€ë¶„ì˜ ë³µì œë³¸ì—ì„œ ë°ì´í„° ë³µì œê°€ ë°œìƒí•˜ë©´ ì“°ê¸°ê°€ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.*

ì´ëŠ” ë¦¬ë”ë¥¼ í¬í•¨í•˜ì—¬ 3ê°œ ë…¸ë“œ ì¤‘ 2ê°œ ë…¸ë“œì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±í–ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì¦‰, ì“°ê¸°ê°€ ì„±ê³µí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.

ì‹¤íŒ¨í•œ ë³µì œë³¸ì´ ì˜¨ë¼ì¸ ìƒíƒœê°€ ë˜ë©´ í•´ë‹¹ ë³µì œë³¸ì—ì„œë„ ë°ì´í„°ê°€ ë³µì œë©ë‹ˆë‹¤.

```
Majority/Quorum = floor(N/2 + 1); N = í´ëŸ¬ìŠ¤í„°ì˜ ì´ ë…¸ë“œ ìˆ˜
```

| Instances N                                                  | Quorum Q | Fault Tolerance *f=N-Q* |
| ------------------------------------------------------------ | -------- | ----------------------- |
| 1                                                            | 1        | 0                       |
| 2                                                            | 2        | 0                       |
| [ğŸ‘‰](https://emojipedia.org/backhand-index-pointing-right/) 3 | 2        | 1                       |
| 4                                                            | 3        | 1                       |
| [ğŸ‘‰](https://emojipedia.org/backhand-index-pointing-right/) 5 | 3        | 2                       |
| 6                                                            | 4        | 2                       |
| [ğŸ‘‰](https://emojipedia.org/backhand-index-pointing-right/) 7 | 4        | 3                       |
|                                                              |          |                         |

> ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜ì˜ ê²½ìš° ë‚´ê²°í•¨ì„±ì´ í•­ìƒ ìœ ì§€ë˜ë¯€ë¡œ í•­ìƒ í™€ìˆ˜ í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ ìŒì„ ì„ íƒí•˜ì‹­ì‹œì˜¤.

# Install Kubernetes Cluster-the kubeadm-way

1. ì£¼ì–´ì§„ ë¦¬í¬ì§€í† ë¦¬ https://github.com/kodekloudhub/certified-kubernetes-administrator-courseì—ì„œ `Vagrantfile`ì„ ì‚¬ìš©í•˜ì—¬ 1ê°œì˜ ë§ˆìŠ¤í„°, 2ê°œì˜ ì‘ì—…ì-í´ëŸ¬ìŠ¤í„° ì„¤ì •ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

   ```sh
   vagrant up
   ```

   ì„¤ì •ì´ ì™„ë£Œë˜ë©´ í„°ë¯¸ë„ì—ì„œ `vagrant status`ë¥¼ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ í‘œì‹œë©ë‹ˆë‹¤.

   ```sh
   Current machine states:
   
   kubemaster                running (virtualbox)
   kubenode01                running (virtualbox)
   kubenode02                running (virtualbox)
   
   ì´ í™˜ê²½ì€ ì—¬ëŸ¬ VMì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. VMì€ ëª¨ë‘ í˜„ì¬ ìƒíƒœì™€ í•¨ê»˜ ìœ„ì— ë‚˜ì—´ë©ë‹ˆë‹¤. íŠ¹ì • VMì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì„ ë³´ë ¤ë©´ `vagrant status NAME`ì„ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤.
   ```

2. ê°€ì ¸ì˜¨ VMì— ë³„ë„ì˜ ì„¸ì…˜ì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.

   ```sh
   vagrant ssh kubemaster
   ```

   ```sh
   vagrant ssh kubenode01
   ```

   ```sh
   vagrant ssh kubenode02
   ```

3. **ëª¨ë“  ë…¸ë“œì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.**

   ```sh
   sudo modprobe br_netfilter && lsmod | grep br_netfilter
   ```

   This should give you the following output:

   ```sh
   br_netfilter           24576  0
   bridge                155648  1 br_netfilter
   ```

   Further,

   ```sh
   sudo -i
   # iptablesê°€ ì—°ê²°ëœ íŠ¸ë˜í”½ì„ ë³¼ ìˆ˜ ìˆë„ë¡ í—ˆìš©
   cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
   br_netfilter
   EOF
   
   cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
   net.bridge.bridge-nf-call-ip6tables = 1
   net.bridge.bridge-nf-call-iptables = 1
   EOF
   sudo sysctl --system
   
   ## installing container-runtime {DOCKER}
   # removing old versions (if any)
   sudo apt-get remove docker docker-engine docker.io containerd runc
   # setting up apt repository
   sudo apt-get update 
   sudo apt-get install \
       ca-certificates \
       curl \
       gnupg \
       lsb-release 
   curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
   echo \
     "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
     $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   # installing docker runtime
   sudo apt-get update
   sudo apt-get install docker-ce docker-ce-cli containerd.io
   # configuring docker daemon to use systemd for the management of the container's cgroups
   sudo mkdir /etc/docker
   cat <<EOF | sudo tee /etc/docker/daemon.json
   {
     "exec-opts": ["native.cgroupdriver=systemd"],
     "log-driver": "json-file",
     "log-opts": {
       "max-size": "100m"
     },
     "storage-driver": "overlay2"
   }
   EOF
   # restart and enable on boot
   sudo systemctl enable docker
   sudo systemctl daemon-reload
   sudo systemctl restart docker
   
   ## installing kubeadm, kubectl and kubelet
   sudo apt-get update
   sudo apt-get install -y apt-transport-https ca-certificates curl
   sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
   echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
   sudo apt-get update
   sudo apt-get install -y kubelet kubeadm kubectl
   sudo apt-mark hold kubelet kubeadm kubectl
   
   # ë„ì»¤ë¥¼ ì„¤ì¹˜í•˜ê¸° ë•Œë¬¸ì— cgroup ë“œë¼ì´ë²„ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
   ```

4. ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰

   ```sh
   kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.56.2
   ```

   > `--control-plane-endpoint`ëŠ” ë„¤íŠ¸ì›Œí‚¹ ì†”ë£¨ì…˜ CIDR ì™¸ë¶€ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
   > `--apiserver-advertise-address`ì˜ IPëŠ” `enp0s8`ì…ë‹ˆë‹¤. (`ifconfig enp0s8`ì„ ì‚¬ìš©í•˜ê³  `inet` í•„ë“œ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.)

   ëª…ë ¹ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ê°€ ì¶œë ¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

   ```sh
   Your Kubernetes control-plane has initialized successfully!
   
   í´ëŸ¬ìŠ¤í„° ì‚¬ìš©ì„ ì‹œì‘í•˜ë ¤ë©´ ì¼ë°˜ ì‚¬ìš©ìë¡œ ë‹¤ìŒì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
   
     mkdir -p $HOME/.kube
     sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
     sudo chown $(id -u):$(id -g) $HOME/.kube/config
   
   ë˜ëŠ” ë£¨íŠ¸ ì‚¬ìš©ìì¸ ê²½ìš° ë‹¤ìŒì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
     export KUBECONFIG=/etc/kubernetes/admin.conf
   
   ì´ì œ í¬ë“œ ë„¤íŠ¸ì›Œí¬ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.
   ë‹¤ìŒì— ë‚˜ì—´ëœ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ "kubectl apply -f [podnetwork].yaml"ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     https://kubernetes.io/docs/concepts/cluster-administration/addons/
   
   ê·¸ëŸ° ë‹¤ìŒ ê°ê°ì—ì„œ ë£¨íŠ¸ë¡œ ë‹¤ìŒì„ ì‹¤í–‰í•˜ì—¬ ì—¬ëŸ¬ ì‘ì—…ì ë…¸ë“œì— ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
   kubeadm join 192.168.56.2:6443 --token oiaauw.qb1l8dgaknwk4b8j \
   	--discovery-token-ca-cert-hash sha256:1ce828ac52d733c603d3d265174bc1317bfafef51ec92f5b85e26300de7f3b60 
   ```

   **ë”°ë¼ì„œ ë§ˆìŠ¤í„°ì—ì„œ** `sudo` ì‚¬ìš©ì ì•¡ì„¸ìŠ¤ì—ì„œ `logout`í•˜ê³  ì¼ë°˜ ì‚¬ìš©ìë¡œ ë‹¤ìŒì„ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤.

   ```sh
   mkdir -p $HOME/.kube
   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
   sudo chown $(id -u):$(id -g) $HOME/.kube/config
   ```

   ì´ì œ ë„¤íŠ¸ì›Œí‚¹ ì†”ë£¨ì…˜ `Weave net` **ì„ ë§ˆìŠ¤í„°**ì— ì„¤ì¹˜í•©ë‹ˆë‹¤.

   ```sh
   kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
   ```

   **ì´ì œ ì‘ì—…ì ë…¸ë“œì—ì„œ** ë‹¤ìŒì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

   ```sh
   kubeadm join 192.168.56.2:6443 --token oiaauw.qb1l8dgaknwk4b8j --discovery-token-ca-cert-hash sha256:1ce828ac52d733c603d3d265174bc1317bfafef51ec92f5b85e26300de7f3b60 
   ```

   **ì´ì œ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ** ë‹¤ìŒì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

   ```sh
   watch kubectl get nodes
   # wait for all the nodes to come online
   ```
