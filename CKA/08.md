## Configure Applications

### Application Commands

ì˜ˆë¥¼ ë“¤ì–´ `ubuntu`ì™€ ê°™ì€ Docker ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ë•Œë§ˆë‹¤ ì¦‰ì‹œ íŠ¹ì • í”„ë¡œí† ì½œì„ ë”°ë¥´ê³  ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.

```powershell
ğŸ³ Â» docker run ubuntu
ğŸ³ Â» docker ps 
CONTAINER ID   IMAGE   COMMAND   CREATED   STATUS   PORTS   NAMES
```

ê·¸ë˜ë„ `docker ps -a`ë¥¼ ì‹¤í–‰í•˜ë©´ ì»¨í…Œì´ë„ˆ ì„¸ë¶€ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤

```powershell
Aditya :: system32 Â» docker ps -a
CONTAINER ID   IMAGE                       COMMAND                  CREATED              STATUS                      PORTS     NAMES
d227eb4f969d   ubuntu                      "/bin/bash"              About a minute ago   Exited (0) 59 seconds ago             practical_pike
```

ì´ëŠ” `ubuntu` ì´ë¯¸ì§€ì˜ `Dockerfile`ì— ìˆëŠ” `CMD` ëª…ë ¹ ë•Œë¬¸ì…ë‹ˆë‹¤.

```dockerfile
FROM scratch
ADD ubuntu-focal-core-cloudimg-amd64-root.tar.gz /

..............

# APT ëª©ë¡ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
RUN [ -z "$(apt-get indextargets)" ]
# (see https://bugs.launchpad.net/cloud-images/+bug/1699913)

# systemd-detect-virtê°€ "docker"ë¥¼ ë°˜í™˜í•˜ë„ë¡ í•©ë‹ˆë‹¤.
# See: https://github.com/systemd/systemd/blob/aa0c34279ee40bce2f9681b496922dedbadfca19/src/basic/virt.c#L434
RUN mkdir -p /run/systemd && echo 'docker' > /run/systemd/container

CMD ["/bin/bash"]           
```

ë³´ì‹œë‹¤ì‹œí”¼ `bash`ëŠ” í”„ë¡œì„¸ìŠ¤ê°€ ì•„ë‹Œ ì‰˜ì´ë©° `stdout`ì—ì„œ ì…ë ¥ì„ ìˆ˜ì‹ í•˜ì§€ë§Œ ì•„ë¬´ê²ƒë„ ì°¾ì§€ ëª»í•˜ë©´ ì¢…ë£Œë©ë‹ˆë‹¤.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì ì¬ì ìœ¼ë¡œ **run** ëª…ë ¹ `docker run ubuntu sleep 5` ëì— ëª…ë ¹ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìì²´ ì‚¬ìš©ì ì§€ì • `Dockerfile`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```dockerfile
FROM ubuntu

CMD sleep 5
```

ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ `Dockerfile`ì„ ì§€ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```dockerfile
# Dockerfile
FROM ubuntu

CMD ["sleep", "5"]         # CMD ["command", "param1", "param2"]
```

```powershell
ğŸ³ Â» docker build -t ubuntu-sleeper .
[+] Building 0.2s (5/5) FINISHED
 => [internal] load build definition from Dockerfile                                                                                                                                                        0.0s
 => => transferring dockerfile: 72B                                                                                                                                                                         0.0s
 => [internal] load .dockerignore                                                                                                                                                                           0.0s
 => => transferring context: 2B                                                                                                                                                                             0.0s
 => [internal] load metadata for docker.io/library/ubuntu:latest                                                                                                                                            0.0s
 => [1/1] FROM docker.io/library/ubuntu                                                                                                                                                                     0.1s
 => => resolve docker.io/library/ubuntu:latest                                                                                                                                                              0.0s
 => exporting to image                                                                                                                                                                                      0.0s
 => => exporting layers                                                                                                                                                                                     0.0s
 => => writing image sha256:bf9d10e69adc13eb242d05de6c9fa1e9c9b4caef6d9c620950442df511e47238                                                                                                                0.0s
 => => naming to docker.io/library/ubuntu-sleeper
```

```powershell
ğŸ³ Â» docker run ubuntu-sleeper
```

ëª…ë ¹ì¤„ ì¸ìˆ˜ë¡œ `sleep`ì—ì„œ ì´ˆë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?

ì´ë¥¼ ìœ„í•´ `ENTRYPOINT` ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤í–‰í•  ë•Œë§ˆë‹¤ `ENTRYPOINT`ëŠ” `CMD`ì²˜ëŸ¼ ì‘ë™í•˜ì§€ë§Œ ëª…ë ¹ì¤„ ì¸ìˆ˜ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```dockerfile
# Dockerfile
FROM ubuntu

ENTRYPOINT ["sleep"]        
```

```powershell
ğŸ³ Â»  docker build -t ubuntu-sleeper .
[+] Building 0.1s (5/5) FINISHED
 => [internal] load build definition from Dockerfile                                              0.0s
 => => transferring dockerfile: 73B                                                               0.0s
 => [internal] load .dockerignore                                                                 0.0s
 => => transferring context: 2B                                                                   0.0s
 => [internal] load metadata for docker.io/library/ubuntu:latest                                  0.0s
 => CACHED [1/1] FROM docker.io/library/ubuntu                                                    0.0s
 => exporting to image                                                                            0.0s
 => => exporting layers                                                                           0.0s
 => => writing image sha256:9e12bfb37adca3310efa3de95d484541d8818860af830542a97849551ffd9585      0.0s
```

```powershell
ğŸ³ Â» docker run ubuntu-sleeper 10
```

ì—¬ê¸°ì„œ `docker run ubuntu-sleeper 10` ëª…ë ¹ì€ `docker run ubuntu-sleeper sleep 10`ì²˜ëŸ¼ ì‘ë™í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ `docker run ubuntu-sleeper`ë¥¼ ì£¼ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”? 'sleep'ì—ëŠ” ëª…í™•í•˜ê²Œ ì œê³µë˜ì§€ ì•Šì€ ë§¤ê°œë³€ìˆ˜ê°€ í•„ìš”í•˜ë¯€ë¡œ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

`CMD`ì—ì„œ ê¸°ë³¸ ì¸ìˆ˜ë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```dockerfile
# Dockerfile
FROM ubuntu

ENTRYPOINT ["sleep"]   

CMD ["5"]
```

ì—¬ê¸°ì„œ '5'ëŠ” ì¸ìˆ˜ë¡œ ì œê³µë˜ëŠ” ê²ƒì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ 'sleep'ì— ì¶”ê°€ë©ë‹ˆë‹¤. ë”°ë¼ì„œ `docker run ubuntu-sleeper`ì™€ ê°™ì€ ëª…ë ¹ì€ `docker run ubuntu-sleeper sleep 5`ì™€ ê°™ê³  `docker run ubuntu-sleeper 10`ì€ `docker run ubuntu-sleeper sleep 10`ê³¼ ê°™ìŠµë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ Dockerfileì˜ `ENTRYPOINT` ëª…ë ¹ì„ ì¬ì •ì˜í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?

```powershell
	ğŸ³ Â» docker run --name ubuntu-sleeper \
			--entrypoint sleep2.0
			ubuntu-sleeper 10
```

### Application - Commands and Arguments

í•˜ì§€ë§Œ ì´ ì´ë¯¸ì§€ì— ëŒ€í•œ `yml` íŒŒì¼ì„ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œìš”?

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-sleeper-pod
  labels:
    name: ubuntu-sleeper-pod
spec:
  containers:
  - name: ubuntu-sleeper-pod
    image: ubuntu-sleeper
    command: ["sleep2.0"]   # this field overrides the ENTRYPOINT instruction of the Dockerfile
    args: ["10"]            # CMD instruction is overriden here
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"
```

### Configuring Environment Variables in Applications

```powershell
ğŸ³ Â» docker run -e APP_COLOR=pink simple-webapp-color
```

`pod-definition.yml`ì—ì„œ ë™ì¼í•œ ì‘ì—…ì„ ì‹œë„í•©ë‹ˆë‹¤.

```yaml
# pod-definition-2.yml
apiVersion: v1
kind: Pod
metadata:
  name: simple-webapp-color
  labels:
    name: simple-webapp-color
spec:
  containers:
  - name: simple-webapp-color
    image: simple-webapp-color
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"
    ports:
      - containerPort: 8080
    env:
      - name: APP_COLOR
        value: pink
    # env: # using ConfigMaps 
    #   - name: APP_COLOR
    #     valueFrom: 
    #       confifMapKeyRef: #config map path
    # env: # using Secrets 
    #   - name: APP_COLOR
    #     valueFrom: #secret map path
    #       secretKeyRef:
    #         key: 
```

#### Using `ConfigMaps`

**ëª…ë ¹ì  ë°©ë²•:**

```powershell
ğŸ³ Â» kubectl create configmap \
			app-config --from-literal=APP_COLOR=blue \
					   --from-literal=APP_MODE=prod
```

```bash
# app_config.properties
APP_COLOR=blue
APP_MODE=prod
```

```powershell
ğŸ³ Â» kubectl create configmap \
			app-config --from-file=app_config.properties
```

**ì„ ì–¸ì  ë°©ë²•:**

```yaml
# config-map.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  APP_COLOR: blue
  APP_MODE: prod
```

```powershell
ğŸ³ Â» kubectl create -f config-map.yaml
configmap/app-config created
ğŸ³ Â» kubectl get configmaps
NAME         DATA   AGE
app-config   2      13s
ğŸ³ Â» kubectl describe configmap/app-config
Name:         app-config
Namespace:    default   
Labels:       <none>    
Annotations:  <none>    

Data
====
APP_COLOR:
----
blue
APP_MODE:
----
prod
```

```yaml
# pod-definition-2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: simple-webapp-color
  labels:
    name: simple-webapp-color
spec:
  containers:
  - name: simple-webapp-color
    image: simple-webapp-color
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"
    ports:
      - containerPort: 8080
    envFrom:
      - configMapRef:
          name: app-config
```

`configMaps`ë¥¼ ì‚½ì…í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

1. ```yaml
   	envFrom:
         - configMapRef:
             name: app-config
   ```

2. ```yaml
       env:
         - name: APP_COLOR
           valueFrom:
             configMapKeyRef:
               name: app-config
               key: APP_COLOR
   ```

3. ```yaml
       volumes:
       - name: app-config-volume
         configMap:
           name: app-config
   ```

> `kubectl get pod webapp-color -o yaml > pod.yaml`

#### Use `Secrets`

##### Imperative way of creating a `secret` 

```bash
kubectl create secret generic \
	<secret-name> --from-literal=<key>=<value>
```

Example,

```bash
kubectl create secret generic \
	app-secret --from-literal=DB_Host=mysql \
				--from-literal=DB_User=root \
				--from-literal=DB_Password=paswrd
```

íŒŒì¼ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
kubectl create secret generic \
	<secret-name> --from-file=<path-to-file>
```

ì˜ˆë¥¼ ë“¤ë©´,

```bash
kubectl create secret generic \
	app-secret --from-file=app_secret.properties
```



##### Declarative way of creating a `secret`

```yaml
# secret-data.yml

apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  DB_Host: mysql
  DB_User: root
  DB_Password: paswrd
```

ê·¸ëŸ¬ë‚˜ ì´ê²ƒì€ ì•ˆì „í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‘ì—…ì„ ìœ„í•´ ì´ê²ƒì„ ì¸ì½”ë”©ëœ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

```yaml
# secret-data.yml

apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  DB_Host: bQB5AHMAcQBsAA==
  DB_User: cgBvAG8AdAA=
  DB_Password: bQB5AHMAcQBsAA==
```

ì¼ë°˜ í…ìŠ¤íŠ¸ë¥¼ `base64`ë¡œ ë³€í™˜í•˜ë ¤ë©´

in Windows

```powershell
$MYTEXT = 'root' ;  $ENCODED = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($MYTEXT)) ; Write-Output $Encoded
```

in Linux

```bash
echo -n 'root' | base64
```

'secret'ì„ ìƒì„±í•˜ë ¤ë©´ ë‹¤ìŒì„ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤.

```bash
kubectl create -f secret-data.yml
kubetl get secrets

NAME                    TYPE                                  DATA   AGE
app-secret              Opaque                                3      11s
dashboard-token-6vdhl   kubernetes.io/service-account-token   3      75d
default-token-jl8bg     kubernetes.io/service-account-token   3      81d
```

```powershell
kubectl describe secret app-secret  

Name:         app-secret
Namespace:    default   
Labels:       <none>    
Annotations:  <none>    

Type:  Opaque

Data
====
DB_Host:      10 bytes  
DB_Password:  10 bytes  
DB_User:      8 bytes   
```

ëª¨ë“  ê°’ë„ ë³´ë ¤ë©´,

```powershell
kubectl get secret app-secret -o yaml

apiVersion: v1
data:
  DB_Host: bQB5AHMAcQBsAA==
  DB_Password: bQB5AHMAcQBsAA==
  DB_User: cgBvAG8AdAA=
kind: Secret
metadata:
  creationTimestamp: "2021-04-13T05:48:18Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:DB_Host: {}
        f:DB_Password: {}
        f:DB_User: {}
      f:type: {}
    manager: kubectl-create
    operation: Update
    time: "2021-04-13T05:48:18Z"
  name: app-secret
  namespace: default
  resourceVersion: "386643"
  selfLink: /api/v1/namespaces/default/secrets/app-secret
  uid: 3797a0c5-ffb1-4a15-9ec5-f6aefd642ecb
type: Opaque
```

secretì„ ì‚¬ìš©í•˜ë„ë¡ í¬ë“œ êµ¬ì„±

1. 'secret'ì„ ì™„ì „íˆ ì‚¬ìš©	

   ```yaml
   # pod-definition-3.yml
   apiVersion: v1
   kind: Pod
   metadata:
     name: pod-with-secret
     labels:
       name: pod-with-secret
   spec:
     containers:
     - name: pod-with-secret
       image: pod-with-secret
       ports:
         - containerPort: 8080
       envFrom:
         - secretRef:
             name: app-secret
   ```

2. `secret`ì˜ ì„ íƒì  í‚¤ë¥¼ ì‚¬ìš©

   ```yaml
   # pod-definition-3.yml
   apiVersion: v1
   kind: Pod
   metadata:
     name: pod-with-secret
     labels:
       name: pod-with-secret
   spec:
     containers:
     - name: pod-with-secret
       image: pod-with-secret
       ports:
         - containerPort: 8080
       env:
         - name: DB_Password
           valueFrom:
             secretKeyRef:
               name: app-secret
               key: DB_Password
   ```

3. ë³¼ë¥¨ ë‚´ì—ì„œ secret ë§ˆìš´íŠ¸

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     name: pod-with-secret
     labels:
       name: pod-with-secret
   spec:
     containers:
     - name: pod-with-secret
       image: pod-with-secret
       ports:
         - containerPort: 8080
       volume:
         - name: app-secret-volume
           secret: 
             secretName: app-secret
   ```

ë˜í•œ ë‹¤ìŒ ë§í¬ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤. : https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/
