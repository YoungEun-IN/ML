# Cluster Maintenance

## OS Upgrades

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/ClusterMaintantence.svg)

í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œì˜ ê²½ìš° ì •ìƒì ìœ¼ë¡œ ìœ ì§€ ê´€ë¦¬ë¥¼ ìœ„í•´ ë…¸ë“œê°€ ë‹¤ìš´ë˜ê³  5ë¶„ ì´ë‚´ì— ë‹¤ì‹œ ì˜¨ë¼ì¸ ìƒíƒœê°€ ë˜ë©´ ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì§€ë§Œ ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ë…¸ë“œì—ì„œ í¬ë“œê°€ ì¢…ë£Œë©ë‹ˆë‹¤. Podê°€ 'ReplicaSet'ì˜ ì¼ë¶€ì¸ ê²½ìš° ë‹¤ì‹œ ì˜¨ë¼ì¸ ìƒíƒœê°€ ë˜ëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ **pod-eviction-timeout**ìž…ë‹ˆë‹¤.

```powershell
kube-controller-manager --pod-eviction-timeout=5m0s
```

ë”°ë¼ì„œ ë…¸ë“œê°€ 5ë¶„ ì´ë‚´ì— ì˜¨ë¼ì¸ ìƒíƒœê°€ ë˜ë©´ ìœ ì§€ ê´€ë¦¬ ìž‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìžˆì§€ë§Œ ë…¸ë“œê°€ ë‹¤ì‹œ ì˜¨ë¼ì¸ ìƒíƒœê°€ ë ì§€ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìžˆëŠ” ë°©ë²•ì€ ì—†ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ë” ì•ˆì „í•œ ë°©ë²•ì„ ë”°ë¦…ë‹ˆë‹¤.

1. ë…¸ë“œë¥¼ `cordon`í•©ë‹ˆë‹¤. ì¦‰, ë…¸ë“œë¥¼ *ì˜ˆì•½ ë¶ˆê°€*ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. ì§€ì •ëœ ë…¸ë“œë¥¼ ì˜ë„ì ìœ¼ë¡œ 'ë“œë ˆì´ë‹'í•˜ë©´ íŒŸì´ ë“œë ˆì¸ ëŒ€ìƒ ë…¸ë“œì—ì„œ ì‚­ì œë˜ê³  ë‚˜ë¨¸ì§€ ì ê²© ë…¸ë“œì—ì„œ ë‹¤ì‹œ ìƒì„±ë©ë‹ˆë‹¤.

   ```bash
   kubectl cordon node-1 && kubectl drain node-1 --ignore-daemonsets --force --delete-emptydir-data
   ```

2. ê·¸ëŸ° ë‹¤ìŒ ì—…ê·¸ë ˆì´ë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

3. ê·¸ëŸ° ë‹¤ìŒ ë…¸ë“œë¥¼ 'uncordon'í•©ë‹ˆë‹¤.

   ```bash
   kubectl uncordon node-1
   ```

## Kubernetes Software Versions

```bash
ðŸ±â€ðŸ kubectl get nodes
NAME             STATUS   ROLES                  AGE     VERSION
docker-desktop   Ready    control-plane,master   3h16m   v1.21.1
```

ë²„ì „ `v1.21.1`ì€ ë§ˆìŠ¤í„° ë…¸ë“œì— ì„¤ì¹˜ëœ Kubernetes ë²„ì „ìž…ë‹ˆë‹¤.

`v1`ì€ ì£¼ ë²„ì „ìž…ë‹ˆë‹¤.
`21`ì€ ë§ˆì´ë„ˆ ë²„ì „ìœ¼ë¡œ ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.
`1`ì€ í¬í•¨ëœ íŒ¨ì¹˜ ë²„ì „ìž…ë‹ˆë‹¤.

## Cluster Upgrade Process

Kubernetesì—ëŠ” ë‹¤ìŒ êµ¬ì„± ìš”ì†Œê°€ ìžˆìŠµë‹ˆë‹¤.

1. `kube-apiserver`
2. `controller-manager`
3. `kube-scheduler`
4. `kubelet`
5. `kube-proxy`
6. `kubectl`

*ëª¨ë“  êµ¬ì„± ìš”ì†Œê°€ í•œ ë²ˆì— ë™ì¼í•œ ë²„ì „ì´ì–´ì•¼ í•©ë‹ˆê¹Œ?*

ëª¨ë“  êµ¬ì„±ìš”ì†Œ(`kubectl` ì œì™¸)ëŠ” `kube-apiserver` ì´í•˜ ë²„ì „ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

> ë²„ì „(`kube-apiserver`) >= ë²„ì „(ë‹¤ë¥¸ ëª¨ë“  êµ¬ì„±ìš”ì†Œ)

ë”°ë¼ì„œ `kube-apiserver`ëŠ” ë²„ì „ xì´ê³  `controller-manager`ì™€ `kube-scheduler`ëŠ” ìµœëŒ€ x-1(`kube-apiserver`ë³´ë‹¤ í•œ ë²„ì „ ë‚®ìŒ)ì´ê³  `kubelet`ê³¼ `kube-proxy`ëŠ” ìµœì†Œí•œ x-2ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

`kubectl`ì€ x+1, x ë˜ëŠ” x-1ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

### The Process

#### Upgrade Strategies

í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ í”„ë¡œì„¸ìŠ¤ëŠ” ë‹¤ìŒ ë‹¨ê³„ë¡œ ì‹œìž‘ë©ë‹ˆë‹¤.

1. ë¨¼ì € ë§ˆìŠ¤í„°ê°€ ë‹¤ìš´ë˜ê³  ì—…ê·¸ë ˆì´ë“œë©ë‹ˆë‹¤.
   ![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/ClusterMaintantence-Cluster upgrade.svg)

2. ì´ì œ ìž‘ì—…ìž ë…¸ë“œë¥¼ ì—…ê·¸ë ˆì´ë“œí•˜ê¸° ìœ„í•œ 5ê°€ì§€ ì „ëžµì´ ìžˆìŠµë‹ˆë‹¤.
   Reference link here: [Kubernetes deployment strategies (container-solutions.com)](https://blog.container-solutions.com/kubernetes-deployment-strategies)
   
   1. **Recreate Strategy**- Recreate ìœ í˜•ì˜ ì „ëžµìœ¼ë¡œ ì •ì˜ëœ ë°°í¬ëŠ” ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¢…ë£Œí•œ ë‹¤ìŒ ìƒˆ ë²„ì „ìœ¼ë¡œ ë‹¤ì‹œ ë§Œë“­ë‹ˆë‹¤.
   
      ![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/ClusterMaintantence-Cluster upgrade-recreate.svg)
   
      ì´ ì ‘ê·¼ ë°©ì‹ì˜ ë¬¸ì œëŠ” ìž‘ì—…ìž ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ ê°€ë™ ì¤‘ì§€ ì‹œê°„ì´ ë°œìƒí•˜ëŠ” ì‹œì ìž…ë‹ˆë‹¤.
   
      ```yaml
      spec:
        replicas: 3
        strategy:
          type: Recreate
      ```
   
   2. **Ramped - slow rollout** - ëž¨í•‘ ë°°í¬ëŠ” ë¡¤ë§ ì—…ë°ì´íŠ¸ ë°©ì‹ìœ¼ë¡œ í¬ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒˆ ë²„ì „ìœ¼ë¡œ ë³´ì¡° 'ReplicaSet'ê°€ ìƒì„±ëœ ë‹¤ìŒ ì˜¬ë°”ë¥¸ ë³µì œë³¸ ìˆ˜ì— ë„ë‹¬í•  ë•Œê¹Œì§€ ì´ì „ ë²„ì „ì˜ ìˆ˜ë¥¼ ì¤„ì´ê³  ìƒˆ ë²„ì „ì„ ëŠ˜ë¦½ë‹ˆë‹¤.
   
      ![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/Ramped-slow%20rollout.svg)
   
      ```yaml
      spec:
      	replicas: 3
      	strategy:
      		type: RollingUpdate
      		rollingUpdate:
      			maxSurge: 2    # í•œ ë²ˆì— ì¶”ê°€í•  ìˆ˜ ìžˆëŠ” í¬ë“œ ìˆ˜
                  maxUnavailable: 0	# maxUnavailableì€ ë¡¤ë§ ì—…ë°ì´íŠ¸ ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í¬ë“œ ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
      ```
   
      | Pros                                                         | Cons                             |
      | ------------------------------------------------------------ | -------------------------------- |
      | ë²„ì „ì´ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì²œì²œížˆ ë¦´ë¦¬ìŠ¤ë©ë‹ˆë‹¤.                 | ë¡¤ì•„ì›ƒ/ë¡¤ë°±ì—ëŠ” ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.   |
      | ë°ì´í„° ìž¬ì¡°ì •ì„ ì²˜ë¦¬í•  ìˆ˜ ìžˆëŠ” ìƒíƒœ ì €ìž¥ ì• í”Œë¦¬ì¼€ì´ì…˜ì— íŽ¸ë¦¬í•¨ | ì—¬ëŸ¬ APIë¥¼ ì§€ì›í•˜ëŠ” ê²ƒì€ ì–´ë µìŠµë‹ˆë‹¤. |
      |                                                              | íŠ¸ëž˜í”½ í†µì œ ë¶ˆê°€          |
   
   3. **Blue/Green - best to avoid API versioning issues** - ë¸”ë£¨/ê·¸ë¦° ë°°í¬ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ *ê·¸ë¦°* ë²„ì „ì´ *ë¸”ë£¨ ë²„ì „*ê³¼ í•¨ê»˜ ë°°í¬ë˜ê¸° ë•Œë¬¸ì— ëž¨í”„ ë°°í¬ì™€ ë‹¤ë¦…ë‹ˆë‹¤. ìƒˆ ë²„ì „ì´ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•œ í›„ ë¡œë“œ ë°¸ëŸ°ì„œ ì—­í• ì„ í•˜ëŠ” Kubernetes ì„œë¹„ìŠ¤ ê°œì²´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì„ íƒê¸° í•„ë“œì˜ ë²„ì „ ë ˆì´ë¸”ì„ êµì²´í•˜ì—¬ ìƒˆ ë²„ì „ìœ¼ë¡œ íŠ¸ëž˜í”½ì„ ë³´ëƒ…ë‹ˆë‹¤.
   
      ![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/strategy-Canary.svg)
   
      ë‹¤ìŒ ì˜ˆì—ì„œëŠ” 2ê°œì˜ 'ReplicaSets'ë¥¼ ë‚˜ëž€ížˆ ì‚¬ìš©í•©ë‹ˆë‹¤. ë²„ì „ Aì—ëŠ” 3ê°œì˜ ë³µì œë³¸(íŠ¸ëž˜í”½ì˜ 75%)ì´ ìžˆê³  ë²„ì „ Bì—ëŠ” 1ê°œì˜ ë³µì œë³¸(íŠ¸ëž˜í”½ì˜ 25%)ì´ ìžˆìŠµë‹ˆë‹¤.
      
      ìž˜ë¦° ë°°í¬ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ë²„ì „ A:
   
      ```yaml
      spec:
        replicas: 3
      ```
   
      ìž˜ë¦° ë°°í¬ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ë²„ì „ B, ì• í”Œë¦¬ì¼€ì´ì…˜ ë³µì œë³¸ í•˜ë‚˜ë§Œ ì‹œìž‘í•œë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”.
   
      ```yaml
      spec:
        replicas: 1
      ```
   
      | Pros                                                 | Cons                                                         |
      | ---------------------------------------------------- | ------------------------------------------------------------ |
      | ì¼ë¶€ ì‚¬ìš©ìžë¥¼ ìœ„í•´ ì¶œì‹œëœ ë²„ì „              | ëŠë¦° ë¡¤ì•„ì›ƒ                                            |
      | ì˜¤ë¥˜ìœ¨ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì— íŽ¸ë¦¬ | ë¯¸ì„¸ ì¡°ì •ëœ íŠ¸ëž˜í”½ ë¶„ì‚°ì€ ë¹„ìš©ì´ ë§Žì´ ë“¤ ìˆ˜ ìžˆìŠµë‹ˆë‹¤(99% A/ 1% B = 99 í¬ë“œ A, 1 í¬ë“œ B). |
   
      ìœ„ì—ì„œ ì‚¬ìš©ëœ ì ˆì°¨ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤ì´í‹°ë¸Œì´ë©° ë²„ì „ ê°„ì— íŠ¸ëž˜í”½ì„ ë¶„ì‚°í•˜ê¸° ìœ„í•´ 'ReplicaSet'ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë³µì œë³¸ ìˆ˜ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.
   
      ìƒˆ ê¸°ëŠ¥ì˜ ë¦´ë¦¬ìŠ¤ê°€ í”Œëž«í¼ì˜ ì•ˆì •ì„±ì— ë¯¸ì¹  ìˆ˜ ìžˆëŠ” ì˜í–¥ì— ëŒ€í•´ í™•ì‹ ì´ ì—†ìœ¼ë©´ ì¹´ë‚˜ë¦¬ì•„ ë¦´ë¦¬ìŠ¤ ì „ëžµì´ ì œì•ˆë©ë‹ˆë‹¤.
   
   4. **A/B testing  - ì¼ë¶€ ì‚¬ìš©ìžì— ëŒ€í•œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ì— ê°€ìž¥ ì í•©** - A/B í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œë¡œ ë°°í¬ ì „ëžµì´ ì•„ë‹ˆë¼ í†µê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì‚¬ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ê¸°ìˆ ìž…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê´€ë ¨ì´ ìžˆìœ¼ë©° ì¹´ë‚˜ë¦¬ì•„ ë°°í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
      ê°€ì¤‘ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë²„ì „ ê°„ì— íŠ¸ëž˜í”½ì„ ë¶„ì‚°í•˜ëŠ” ê²ƒ ì™¸ì—ë„ ëª‡ ê°€ì§€ ë§¤ê°œë³€ìˆ˜(ì¿ í‚¤, ì‚¬ìš©ìž ì—ì´ì „íŠ¸ ë“±)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§€ì •ëœ ì‚¬ìš©ìž í’€ì„ ì •í™•í•˜ê²Œ íƒ€ê²ŸíŒ…í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì´ ê¸°ìˆ ì€ ê°€ìž¥ ë§Žì´ ë³€í™˜ë˜ëŠ” íŠ¹ì • ê¸°ëŠ¥ì˜ ë³€í™˜ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë° ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.
      ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë©”ì‹œì™€ ë§ˆì°¬ê°€ì§€ë¡œ 'Istio'ëŠ” ê°€ì¤‘ì¹˜ ë°/ë˜ëŠ” HTTP í—¤ë”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ë™ì  ìš”ì²­ ë¼ìš°íŒ…ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì„¸ë¶„í™”í•˜ëŠ” ì„¸ë¶„í™”ëœ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.
      ![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/ClusterMaintantence_a_b%20testing%20strategy.svg)
      
      | Pros                                       | Cons                                                         |
      | ------------------------------------------ | ------------------------------------------------------------ |
      |ì§€ëŠ¥í˜• ë¡œë“œ ë°¸ëŸ°ì„œ í•„ìš” | ì£¼ì–´ì§„ ì„¸ì…˜ì— ëŒ€í•œ ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ê¸° ì–´ë ¤ìš´ ê²½ìš° ë¶„ì‚° ì¶”ì ì´ í•„ìˆ˜ê°€ ë¨ |
      | ì—¬ëŸ¬ ë²„ì „ì´ ë³‘ë ¬ë¡œ ì‹¤í–‰ | ê°„ë‹¨í•˜ì§€ ì•Šì€ ê²½ìš° ì¶”ê°€ ë„êµ¬ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤ |
      | íŠ¸ëž˜í”½ ë¶„í¬ì— ëŒ€í•œ ì™„ì „í•œ ì œì–´ |                                                              |

#### kubeadm - upgrade

> í•œ ë²ˆì— í•˜ë‚˜ì˜ ë§ˆì´ë„ˆ ë²„ì „ë§Œ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

ì´ [Kubeadm í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ | Kubernetes](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/). ì´ ë§í¬ì—ëŠ” í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ì§€ì¹¨ì´ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.

```bash
# ìž‘ì—… ì¤‘ì¸ OS ì°¾ê¸°
cat /etc/*release

# kubeadmì˜ ì •í™•í•œ ëŒ€ìƒ ë²„ì „ íŒŒì•…
apt update
apt-cache madison kubeadm

# ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ
sh controlplane
## ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë“œë ˆì¸
kubectl drain controlplane --ignore-daemonsets
## kubeadm ì—…ê·¸ë ˆì´ë“œ
apt-mark unhold kubeadm && \
apt-get update && \
apt-get upgrade -y kubeadm=1.19.6-00 && \
apt-mark hold kubeadm
### kubeadm ë²„ì „ í™•ì¸
kubeadm version
kubeadm upgrade plan
kubeadm upgrade apply v1.19.6
## kubelet ì—…ê·¸ë ˆì´ë“œ
apt-get upgrade -y kubelet=1.19.6-00
systemctl restart kubelet
kubectl get nodes

# ë¨¼ì € ëŒ€ìƒ ìž‘ì—…ìž ë…¸ë“œì—ì„œ ëŒ€ìƒì´ ì•„ë‹Œ ë‹¤ë¥¸ ìž‘ì—…ìž ë…¸ë“œë¡œ ì›Œí¬ë¡œë“œë¥¼ ì´ë™í•©ë‹ˆë‹¤.
# ëŒ€ìƒ ìž‘ì—…ìž ë…¸ë“œë¥¼ ë¹„ì›ë‹ˆë‹¤. ì´ê²ƒì€ ë˜í•œ ë…¸ë“œë¥¼ ì°¨ë‹¨í•˜ì—¬ ì˜ˆì•½í•  ìˆ˜ ì—†ìŒìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
kubectl drain node-1 --ignore-daemonsets 

# ìž‘ì—…ìž ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ
sh node-1
# kubeadm ë° kubelet ì—…ê·¸ë ˆì´ë“œ

apt-mark unhold kubeadm && \
apt-get update && \
apt-get upgrade -y kubeadm=1.19.6-00 && \
apt-mark hold kubeadm
apt-get upgrade -y kubelet=1.19.6-00
kubeadm upgrade node config --kubelet-version v1.19.6
systemctl daemon-reload &&\
srestart kubelet

kubectl uncordon node-1

# ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ë‹¤ë¥¸ ìž‘ì—…ìž ë…¸ë“œë¥¼ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤.
```

> `kubectl ì—…ê·¸ë ˆì´ë“œ ê³„íš`ì˜ ëŒ€ì•ˆ
>
> ```bash
> kubectl -n kube-system get cm kubeadm-config -oyaml
> ```
>
