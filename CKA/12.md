# Security

## Kubernetes Security Primitives

### í´ëŸ¬ìŠ¤í„°ë¥¼ ë³´í˜¸í•˜ëŠ” ë°©ë²•

#### Step 1 : ëˆ„ê°€ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ”ì§€ ì •ì˜

- Files - Username and Passwords
- Files - Username and Tokens
- Certificates
- External Authentication providers - LDAP
- Service Accounts

#### Step 2 : ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë˜ë©´ ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ì§€ ì •ì˜

- RBAC Authorization
- ABAC Authorization
- Node Authorization
- Webhook Mode

## Authentication

![authPic](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/Authorization.svg)

ì§€ê¸ˆì€ *ì• í”Œë¦¬ì¼€ì´ì…˜ ìµœì¢… ì‚¬ìš©ì*ë¥¼ ê·¸ëŒ€ë¡œ ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì‚¬ìš©ìë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ,

1. User Accounts âœ–
   1. Admins âœ–
   2. Developers âœ–
2. Service Accounts âœ”
   1. Bots/Third-Party Applications

> Kubernetesì—ì„œ `kubectl create user user1`ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ Kubernetesì—ì„œ `serviceaccount`ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
kubernetes create serviceaccount sa1

kubernetes get serviceaccount
```

[ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ ì°¸ê³  ì‚¬í•­](#a-note-on-service-accounts)ì—ì„œ ë‹¤ë£¹ë‹ˆë‹¤.

ì‚¬ìš©ì ê³„ì •ì˜ ê²½ìš° `kubectl` ë˜ëŠ” `curl https://kube-server-ip:6443/`ì„ í†µí•œ ëª¨ë“  ìš”ì²­ì€ `kube-apiserver`ë¥¼ í†µê³¼í•˜ê³  ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ì „ì— ì¸ì¦í•©ë‹ˆë‹¤.

### ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ì€ kube-apiserverì—ì„œ ì–´ë–»ê²Œ ì‘ë™í•©ë‹ˆê¹Œ?

We can have:

1. Static Password Files
2. Static Token Files
3. Certificates
4. Identity Services (third-party auth) - LDAP, Kerberos, etc.

#### Static Password Files

##### Auth Mechanisms - Basic

`user-details.csv`ë¼ëŠ” íŒŒì¼ì´ ìˆë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤.

í…Œì´ë¸” êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

| Password    | Username | UserID | Group  |
| ----------- | -------- | ------ | ------ |
| password123 | user1    | u0001  | group1 |
| password123 | user2    | u0002  | group2 |
| password123 | user3    | u0003  | group1 |

ì²« ë²ˆì§¸ ì—´ì€ ë¹„ë°€ë²ˆí˜¸ì´ê³  ì‚¬ìš©ì ì´ë¦„, ì‚¬ìš©ì ID ë° ê·¸ë£¹ ì´ë¦„ì…ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ ì´ íŒŒì¼ì„ `--basic-auth-file=user-details.csv` ì˜µì…˜ìœ¼ë¡œ `kube-apiserver`ì— ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜ëŠ” `/etc/kubernetes/manifests/kube-apiserver.yaml`ì— ìˆëŠ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ yamlì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
 name: kube-apiserver
 namespace: kube-system
spec:
 containers:
 - command:
  - kube-apiserver
  - --authorization-mode=Node, RBAC
  - --advertise-address=172.17.0.107
  ...
  ...
  - --basic-auth-file=/tmp/users/user-details.csv
  image: k8s.gcr.io/kube-apiserver:v1.9.7
  name: kube-apiserver
```

`kubeadm` ë„êµ¬ëŠ” ìë™ìœ¼ë¡œ ë³€ê²½ ì‚¬í•­ì„ ì„ íƒí•˜ê³  `kube-apiserver`ë¥¼ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.

###### ì‚¬ìš©ìì— ëŒ€í•œ ì—­í•  ë° ì—­í•  ë°”ì¸ë”©

```yaml
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [""] # "" indicates the core API group
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
 
---
# ì´ ì—­í•  ë°”ì¸ë”©ì„ í†µí•´ "jane"ì€ "default" ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ í¬ë“œë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods
  namespace: default
subjects:
- kind: User
  name: user1 # Name is case sensitive
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role #this must be Role or ClusterRole
  name: pod-reader # ë°”ì¸ë”©í•˜ë ¤ëŠ” ì—­í•  ë˜ëŠ” ClusterRoleì˜ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
  apiGroup: rbac.authorization.k8s.io
```

###### To request for authentication

```bash
curl -v -k https://master-node-ip:6443/api/v1/pods -u "user1:password123"
```

#### Static Token Files

##### Auth Mechanism - Basic

ë§ˆì°¬ê°€ì§€ë¡œ í† í° íŒŒì¼ì— ëŒ€í•´ì„œë„ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
--token-auth-file=user-details.csv
```

| Bearer Token                  | Username | UserID | Group  |
| ----------------------------- | -------- | ------ | ------ |
| asdaf32jkh1k4jh124jhg23j4hgjk | user10   | u0001  | group1 |
| asdaf32jkh1k4jh124jhg23j4hgjk | user11   | u0002  | group  |
| asdaf32jkh1k4jh124jhg23j4hgjk | user12   | u0003  | group1 |

###### To request for authentication

```bash
curl -v -k https://master-node-ip:6443/api/v1/pods --header "Authorization: Bearer asdaf32jkh1k4jh124jhg23j4hgjk"
```

> ì´ê²ƒì€ ê¶Œì¥ë˜ëŠ” ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ì´ ì•„ë‹™ë‹ˆë‹¤.
>
> kubeadm ì„¤ì •ì—ì„œ ì¸ì¦ íŒŒì¼ì„ ì œê³µí•˜ëŠ” ë™ì•ˆ ë³¼ë¥¨ ë§ˆìš´íŠ¸ë¥¼ ê³ ë ¤í•˜ì‹­ì‹œì˜¤.
>
> ìƒˆ ì‚¬ìš©ìì— ëŒ€í•œ ì—­í•  ê¸°ë°˜ ê¶Œí•œ ë¶€ì—¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

## A note on Service Accounts

Reference link: [Kubernetes Service Account in detail | Service Account tutorial - YouTube](https://www.youtube.com/watch?v=zfiz-oOeyMg&ab_channel=VivekSingh)

Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì‹¤í–‰ ì¤‘ì´ê³  ë§ì€ ì‚¬ìš©ìê°€ í´ëŸ¬ìŠ¤í„°ì— ì•¡ì„¸ìŠ¤í•´ì•¼ í•œë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤.

- Admins (human users)
- Developers (human users)
- Clients (human users)
- TPA (non-human users) - managed by service accounts

ì„œë¹„ìŠ¤ ê³„ì •ì€ Kubernetes í´ëŸ¬ìŠ¤í„° ì•¡ì„¸ìŠ¤ì— í•„ìš”í•œ ê¶Œí•œì„ ì œê³µí•˜ëŠ” ì—”í„°í‹°ì…ë‹ˆë‹¤.

### Service Account Controllers

Kubernetes ì»¨íŠ¸ë¡¤ëŸ¬ ê´€ë¦¬ìì˜ ì¼ë¶€ë¡œ ì‹¤í–‰ë˜ëŠ” *ì„œë¹„ìŠ¤ ê³„ì • ì»¨íŠ¸ë¡¤ëŸ¬*ë¼ëŠ” ì¼ë¶€ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ìˆìœ¼ë©° ëª¨ë“  Kubernetes ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ 'ê¸°ë³¸' ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

### Default Service Account in a Pod and privilege

íŠ¹ì • ë¦¬ì†ŒìŠ¤(ì˜ˆ: ì§€ì •ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ëŠ” í¬ë“œ)ì— ëŒ€í•œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ `default` ì„œë¹„ìŠ¤ ê³„ì •ì´ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ì— ì—°ê²°ë©ë‹ˆë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ ê³„ì •ì´ í¬ë“œì—ì„œ ìš”ì²­í•œ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìœ¼ë©´ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

```powershell
kidad in System32 â¯ kubectl create ns test
namespace/test created
kidad in System32 â¯ kubectl get serviceaccounts -n test
NAME      SECRETS   AGE
default   1         58s
```

ê° ì„œë¹„ìŠ¤ ê³„ì •ì—ëŠ” ì—°ê²°ëœ secretì´ ìˆìŠµë‹ˆë‹¤. ì—°ê²°ëœ secretì´ ë§ˆìš´íŠ¸ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
kidad in System32 â¯ kubectl describe serviceaccounts -n test default
Name:                default
Namespace:           test
Labels:              <none>
Annotations:         <none>
Image pull secrets:  <none>
Mountable secrets:   default-token-k868l
Tokens:              default-token-k868l
Events:              <none>

kidad in System32 â¯ kubectl get secrets -n test
NAME                  TYPE                                  DATA   AGE
default-token-k868l   kubernetes.io/service-account-token   3      11m

kidad in System32 â¯ kubectl get secrets -n test default-token-k868l -oyaml
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiB.....URS0tLS0tCg==
  namespace: dGVzdA==
  token: ZXlKaGJHY2lPaUpTVXp......yWUVpdw==
kind: Secret
metadata:
  annotations:
    kubernetes.io/service-account.name: default
    kubernetes.io/service-account.uid: 47ffa0ea-ab9c-45a9-9ba2-41c405fdd909
  creationTimestamp: "2021-07-23T02:38:36Z"
  name: default-token-k868l
  namespace: test
  resourceVersion: "107035"
  uid: 1601f4f7-123e-46bb-b208-03e88c67f033
type: kubernetes.io/service-account-token
```

'ca.crt'ëŠ” kube-apiserverì—ì„œ ì‚¬ìš©í•˜ëŠ” CA ì¸ì¦ì„œë¥¼ base64ë¡œ ì¸ì½”ë”©í•œ ê²ƒì…ë‹ˆë‹¤.

`/etc/kubernetes/pki/ca.crt`ë¡œ ì´ë™í•˜ì—¬ ì´ë¥¼ base64ë¡œ ë””ì½”ë”©ëœ ë²„ì „ì˜ `ca.crt`ì™€ ë¹„êµí•˜ì—¬ ì‹¤ì œë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`token`ì€ ì‹¤ì œë¡œ `kube-apiserver`ë¡œ ì „ë‹¬ë˜ëŠ” ì•”í˜¸í™”ëœ JWT í† í°ì…ë‹ˆë‹¤.

`kube-apiserver`ì— ì§ì ‘ ì ‘ê·¼í•´ ë´…ì‹œë‹¤.

`~/.kube`ë¥¼ ì—½ë‹ˆë‹¤. `config` íŒŒì¼ì„ ì°¾ê³  `server`ë¼ëŠ” í•˜ìœ„ í•„ë“œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.

> Docker Desktopì˜ ê²½ìš° ì—¬ì „íˆ ìœ„ì˜ ë””ë ‰í† ë¦¬ë¡œ ì§ì ‘ `cd`í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTi....FURS0tLS0tCg==
   server: https://kubernetes.docker.internal:6443   ğŸ‘ˆ
  name: docker-desktop
contexts:
- context:
    cluster: docker-desktop
    user: docker-desktop
  name: docker-desktop
current-context: docker-desktop
kind: Config
preferences: {}
users:
- name: docker-desktop
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDR.....JUSUZJQ0FURS0tLS0tCg==
    client-key-data: LS0tLS1CRUdJTiBSU0EgUF.....SBLRVktLS0tLQo=

```

url [https://kubernetes.docker.internal:6443](https://kubernetes.docker.internal:6443/)ì— ë„ë‹¬í•˜ë©´ **403 Forbidden** ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

```json
{
    "kind": "Status",
    "apiVersion": "v1",
    "metadata": {},
    "status": "Failure",
    "message": "forbidden: User \"system:anonymous\" cannot get path \"/api\"",
    "reason": "Forbidden",
    "details": {},
    "code": 403
}
```

í•˜ì§€ë§Œ ì‹¤ì œë¡œ ì´ ì„œë²„ì— ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. serviceaccount yaml `kubectl get secrets -n test -oyaml`ì—ì„œ í† í°ì„ ì„ íƒí•˜ê³  í•´ë‹¹ URLì„ ë‹¤ì‹œ ëˆŒëŸ¬ base64 ë””ì½”ë”©ëœ í† í°ì„ í—¤ë”ì— ë„£ìŠµë‹ˆë‹¤. (yaml íŒŒì¼ì—ëŠ” ì›ë˜ í† í°ì´ í¬í•¨ë˜ì–´ ìˆìŒ) ë¹„ë°€ ì„¤ëª… `kubectl describe secrets -n test`ì—ì„œ í† í°ì„ ì§ì ‘ ë„£ìŠµë‹ˆë‹¤.

```bash
curl https://kubernetes.docker.internal:6443/api --insecure --header "Authorization: Bearer REPLACE_THIS_WITH_DECODED_TOKEN"
```

ì´ì œ **202 ì‘ë‹µ**ì„ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.

```json
{
    "kind": "APIVersions",
    "versions": [
        "v1"
    ],
    "serverAddressByClientCIDRs": [
        {
            "clientCIDR": "0.0.0.0/0",
            "serverAddress": "192.168.65.4:6443"
        }
    ]
}
```

`test` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ í¬ë“œë¥¼ ì‹¤í–‰í•´ ë´…ì‹œë‹¤.

```powershell
kubectl run nginx --image nginx -n test
```

í¬ë“œì— `exec`ì„ ì‹¤í–‰í•´ ë´…ì‹œë‹¤.

```bash
kubectl exec -it -n test nginx -- bash
root@nginx:cd /var/run/secrets/kubernetes.io/serviceaccount
root@nginx:/var/run/secrets/kubernetes.io/serviceaccount# ls -l
total 0
lrwxrwxrwx 1 root root 13 Jul 24 14:38 ca.crt -> ..data/ca.crt
lrwxrwxrwx 1 root root 16 Jul 24 14:38 namespace -> ..data/namespace
lrwxrwxrwx 1 root root 12 Jul 24 14:38 token -> ..data/token
root@nginx:/var/run/secrets/kubernetes.io/serviceaccount# cat ca.crt
-----BEGIN CERTIFICATE-----
MIIC5zCCAc+gAwI....9fPz07Y0OBj2D/X
-----END CERTIFICATE-----
```

ì• í”Œë¦¬ì¼€ì´ì…˜ì´ `kube-apiserver`ì— ì—°ê²°í•˜ë ¤ê³  í•œë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ Podì—ì„œ `/var/run/secrets/kubernetes.io/serviceaccount` ìœ„ì¹˜ë¥¼ ì°¾ëŠ” Kubernetes í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ê±°ê¸°ì—ì„œ í•„ìš”í•œ ì¸ì¦ ì „ì œ ì¡°ê±´ì„ ê°€ì ¸ì˜¤ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ `kube-apiserver`ì— ë„ë‹¬í•©ë‹ˆë‹¤.

ê°„ë‹¨í•œ ì˜ˆë¥¼ ë“¤ë©´ `bitnami/kubectl` ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬ë¥¼ ìƒì„±í•˜ê³  `sleep` ëª…ë ¹ì„ ì£¼ì…í•©ë‹ˆë‹¤.

```bash
kubectl create deployment kctl-depl --image bitnami/kubectl --dry-run -oyaml > deployment.yaml
```

yaml íŒŒì¼ì„ í¸ì§‘í•˜ê³  ëª…ë ¹ì„ ì‚½ì…í•©ë‹ˆë‹¤.

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: kctl-depl
  name: kctl-depl
  namespace: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kctl-depl
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: kctl-depl
    spec:
      containers:
        - image: bitnami/kubectl
          name: kubectl
          command: ['sleep', '1000000'] ğŸ‘ˆ
          resources: {}
status: {}
```

ì´ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.

```bash
kubectl create -f deployment.yaml
kubectl get pods -n test
NAME                         READY   STATUS    RESTARTS   AGE
kctl-depl-7495488c7b-c25mn   1/1     Running   0          6m7s
```

ì´ í¬ë“œë¥¼ ì‹¤í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```powershell
kubectl exec -it -n test kctl-depl-7495488c7b-c25mn -- bash
I have no name!@kctl-depl-7495488c7b-c25mn:/$ kubectl api-resources # ì´ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
```

| NAME                            | SHORTNAMES | APIVERSION                           | NAMESPACED | KIND                           |
| ------------------------------- | ---------- | ------------------------------------ | ---------- | ------------------------------ |
| bindings                        |            | v1                                   | TRUE       | Binding                        |
| componentstatuses               | cs         | v1                                   | FALSE      | ComponentStatus                |
| configmaps                      | cm         | v1                                   | TRUE       | ConfigMap                      |
| endpoints                       | ep         | v1                                   | TRUE       | Endpoints                      |
| events                          | ev         | v1                                   | TRUE       | Event                          |
| limitranges                     | limits     | v1                                   | TRUE       | LimitRange                     |
| namespaces                      | ns         | v1                                   | FALSE      | Namespace                      |
| nodes                           | no         | v1                                   | FALSE      | Node                           |
| persistentvolumeclaims          | pvc        | v1                                   | TRUE       | PersistentVolumeClaim          |
| persistentvolumes               | pv         | v1                                   | FALSE      | PersistentVolume               |
| pods                            | po         | v1                                   | TRUE       | Pod                            |
| podtemplates                    |            | v1                                   | TRUE       | PodTemplate                    |
| replicationcontrollers          | rc         | v1                                   | TRUE       | ReplicationController          |
| resourcequotas                  | quota      | v1                                   | TRUE       | ResourceQuota                  |
| secrets                         |            | v1                                   | TRUE       | Secret                         |
| serviceaccounts                 | sa         | v1                                   | TRUE       | ServiceAccount                 |
| services                        | svc        | v1                                   | TRUE       | Service                        |
| mutatingwebhookconfigurations   |            | admissionregistration.k8s.io/v1      | FALSE      | MutatingWebhookConfiguration   |
| validatingwebhookconfigurations |            | admissionregistration.k8s.io/v1      | FALSE      | ValidatingWebhookConfiguration |
| customresourcedefinitions       | crd, crds  | apiextensions.k8s.io/v1              | FALSE      | CustomResourceDefinition       |
| apiservices                     |            | apiregistration.k8s.io/v1            | FALSE      | APIService                     |
| controllerrevisions             |            | apps/v1                              | TRUE       | ControllerRevision             |
| daemonsets                      | ds         | apps/v1                              | TRUE       | DaemonSet                      |
| deployments                     | deploy     | apps/v1                              | TRUE       | Deployment                     |
| replicasets                     | rs         | apps/v1                              | TRUE       | ReplicaSet                     |
| statefulsets                    | sts        | apps/v1                              | TRUE       | StatefulSet                    |
| tokenreviews                    |            | authentication.k8s.io/v1             | FALSE      | TokenReview                    |
| localsubjectaccessreviews       |            | authorization.k8s.io/v1              | TRUE       | LocalSubjectAccessReview       |
| selfsubjectaccessreviews        |            | authorization.k8s.io/v1              | FALSE      | SelfSubjectAccessReview        |
| selfsubjectrulesreviews         |            | authorization.k8s.io/v1              | FALSE      | SelfSubjectRulesReview         |
| subjectaccessreviews            |            | authorization.k8s.io/v1              | FALSE      | SubjectAccessReview            |
| horizontalpodautoscalers        | hpa        | autoscaling/v1                       | TRUE       | HorizontalPodAutoscaler        |
| cronjobs                        | cj         | batch/v1                             | TRUE       | CronJob                        |
| jobs                            |            | batch/v1                             | TRUE       | Job                            |
| certificatesigningrequests      | csr        | certificates.k8s.io/v1               | FALSE      | CertificateSigningRequest      |
| leases                          |            | coordination.k8s.io/v1               | TRUE       | Lease                          |
| endpointslices                  |            | discovery.k8s.io/v1                  | TRUE       | EndpointSlice                  |
| events                          | ev         | events.k8s.io/v1                     | TRUE       | Event                          |
| ingresses                       | ing        | extensions/v1beta1                   | TRUE       | Ingress                        |
| flowschemas                     |            | flowcontrol.apiserver.k8s.io/v1beta1 | FALSE      | FlowSchema                     |
| prioritylevelconfigurations     |            | flowcontrol.apiserver.k8s.io/v1beta1 | FALSE      | PriorityLevelConfiguration     |
| ingressclasses                  |            | networking.k8s.io/v1                 | FALSE      | IngressClass                   |
| ingresses                       | ing        | networking.k8s.io/v1                 | TRUE       | Ingress                        |
| networkpolicies                 | netpol     | networking.k8s.io/v1                 | TRUE       | NetworkPolicy                  |
| runtimeclasses                  |            | node.k8s.io/v1                       | FALSE      | RuntimeClass                   |
| poddisruptionbudgets            | pdb        | policy/v1                            | TRUE       | PodDisruptionBudget            |
| podsecuritypolicies             | psp        | policy/v1beta1                       | FALSE      | PodSecurityPolicy              |
| clusterrolebindings             |            | rbac.authorization.k8s.io/v1         | FALSE      | ClusterRoleBinding             |
| clusterroles                    |            | rbac.authorization.k8s.io/v1         | FALSE      | ClusterRole                    |
| rolebindings                    |            | rbac.authorization.k8s.io/v1         | TRUE       | RoleBinding                    |
| roles                           |            | rbac.authorization.k8s.io/v1         | TRUE       | Role                           |
| priorityclasses                 | pc         | scheduling.k8s.io/v1                 | FALSE      | PriorityClass                  |
| csidrivers                      |            | storage.k8s.io/v1                    | FALSE      | CSIDriver                      |
| csinodes                        |            | storage.k8s.io/v1                    | FALSE      | CSINode                        |
| csistoragecapacities            |            | storage.k8s.io/v1beta1               | TRUE       | CSIStorageCapacity             |
| storageclasses                  | sc         | storage.k8s.io/v1                    | FALSE      | StorageClass                   |
| volumeattachments               |            | storage.k8s.io/v1                    | FALSE      | VolumeAttachment               |

yaml íŒŒì¼ ìì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ìë™ ì„œë¹„ìŠ¤ ê³„ì • ë§ˆìš´íŠ¸ë¥¼ ë¹„í™œì„±í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    name: nginx
    namespace: test2
spec:
  automountServiceAccountToken: false
  containers:
    - name: nginx
      image: nginx
      resources:
        limits:
          memory: '128Mi'
          cpu: '500m'
```

ì—¬ê¸°ì„œëŠ” í¬ë“œ ë‚´ì—ì„œ `/var/run/secrets` ë””ë ‰í† ë¦¬ë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### Custom service accounts

```powershell
kubectl create serviceaccount customsa
serviceaccount/customsa created

kubectl get secrets
NAME                   TYPE                                  DATA   AGE
customsa-token-ktv9z   kubernetes.io/service-account-token   3      22s ğŸ‘ˆ
default-token-rnpqs    kubernetes.io/service-account-token   3      25h
```

## TLS

### TLS Basics

#### Symmetric Encryption

![](https://github.com/aditya109/learning-k8s/blob/main/assets/symmetric_enc.png?raw=true)

ì—¬ê¸°ì—ì„œ ë°œì‹ ìì™€ ìˆ˜ì‹ ì ëª¨ë‘ ë™ì¼í•œ ë§¤ì²´ë¥¼ í†µí•´ ê³µìœ ë˜ëŠ” ì¸ì½”ë”© ë° ë””ì½”ë”©ì— ë™ì¼í•œ ì•”í˜¸í™” í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤(*ì†ìƒëœ* ê²ƒìœ¼ë¡œ ê°„ì£¼ë¨). ì´ê²ƒì€ ì•”í˜¸í™”ë¥¼ ë§¤ìš° ë¶ˆì•ˆì •í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.

#### Asymmetric Encryption

![](https://github.com/aditya109/learning-k8s/blob/main/assets/asymmetric_enc.png?raw=true)

ì—¬ê¸°ì—ëŠ” ê°œì¸ í‚¤ì™€ ê³µê°œ í‚¤ì˜ ë‘ ê°€ì§€ í‚¤ê°€ ìˆìŠµë‹ˆë‹¤.

*ê³µê°œ í‚¤*ëŠ” *ê°œì¸ í‚¤*ì— ì˜í•´ì„œë§Œ í•´ë…ë  ìˆ˜ ìˆëŠ” í…ìŠ¤íŠ¸ë¥¼ ì¸ì½”ë”©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

##### ë¹„ëŒ€ì¹­ ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¼ìš°ë“œ ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì•¡ì„¸ìŠ¤

`Server-1`ê³¼ `Server-2`ë¼ëŠ” 2ê°œì˜ ì„œë²„ê°€ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.

`root`/`admin` ì‚¬ìš©ìì˜ ê²½ìš° ì„œë²„ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ ë¨¼ì € ê°œì¸ ë° ê³µê°œ í‚¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

```bash
> ssh-keygen
id_rsa id_rsa.pub
```

ê·¸ëŸ° ë‹¤ìŒ ì‚¬ìš©ìëŠ” ê³µê°œ í‚¤ë¥¼ `~\.ssh\authorized_keys` ë””ë ‰í† ë¦¬ì— ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ ì„œë²„ì— ë¡œê·¸ì¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©ìëŠ” ìì‹ ì˜ ì»´í“¨í„°ì— ìˆëŠ” ê°œì¸ í‚¤ì˜ ìœ„ì¹˜ë¥¼ â€‹â€‹ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
ssh -i id_rsa admin@server1
Successfully logged in !
```

ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë™ì¼í•œ ì„œë²„ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ëŠ” ê²½ìš° `admin` ì‚¬ìš©ìëŠ” ë™ì¼í•œ ìœ„ì¹˜ `~\.ssh\authorized_keys` ìœ„ì¹˜ì— ê³µê°œ í‚¤ë¥¼ ë°°ì¹˜í•  ìˆ˜ ìˆìœ¼ë©° ì´ì œ ì‚¬ìš©ìëŠ” ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ì„œë²„ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/asymmetric_enc-asym_enc.svg?raw=true)

#### Accessing secure bank servers

[Symmetric Encryption](#Symmetric Encryption)ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´ ì´ ë°©ë²•ë§Œìœ¼ë¡œëŠ” ì„œë²„ë¥¼ ë³´í˜¸í•  ìˆ˜ ì—†ì—ˆì„ ê²ƒì…ë‹ˆë‹¤.

ì„œë²„ ë³´ì•ˆì„ ìœ„í•´ì„œëŠ” ëŒ€ì¹­ ì•”í˜¸í™”ì™€ ë¹„ëŒ€ì¹­ ì•”í˜¸í™”ë¥¼ ì¡°í•©í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ì¢‹ì•„, ë¡¤ë°±í•˜ì. ì´ì œ ë™ì¼í•œ ì˜ˆë¥¼ ë“¤ì–´ í†µì‹  ì±„ë„ì´ ì†ìƒë˜ì—ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/asymmetric_enc-bank-server-1.svg?raw=true)

ë¨¼ì € ë¸Œë¼ìš°ì €ëŠ” ì¼ë¶€ ëŒ€ì¹­ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ìê²© ì¦ëª…ì„ ì•”í˜¸í™”í•˜ê³  ì†ìƒëœ ë¼ì¸ì„ í†µí•´ ë³´ëƒ…ë‹ˆë‹¤. ì´ì œ ìŠ¤ë‹ˆí¼ëŠ” ì•”í˜¸í™”ëœ ìê²© ì¦ëª…ì„ ê°€ì§€ì§€ë§Œ ëŒ€ì¹­ í‚¤ê°€ ì—†ê¸° ë•Œë¬¸ì— ì•„ë¬´ ê²ƒë„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ ì€í–‰ ì„œë²„ëŠ” ìì²´ ê³µê°œ ë° ê°œì¸ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```bash
> openssl genrsa -out my-bank.key 1024
my-bank.key # public bank key
> openssl rsa -in my-bank.key -pubout > mybank.pem
my-bank.key mybank.pem # later one is private bank key
```

![](https://github.com/aditya109/learning-k8s/blob/main/assets/bank-server-access-2.png?raw=true)

ê·¸ëŸ° ë‹¤ìŒ ì€í–‰ì€ ìŠ¤ë‹ˆí¼ê°€ ì´ë¯¸ ì€í–‰ ì„œë²„ ê³µê°œ í‚¤ì˜ ì‚¬ë³¸ì„ ê°€ì§€ê³  ìˆë‹¤ê³  ê°€ì •í•˜ê³  ê³µê°œ í‚¤ë¥¼ ì±„ë„ì„ í†µí•´ ì‚¬ìš©ìì—ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ í˜¸ìŠ¤íŠ¸ì˜ ë¸Œë¼ìš°ì €ëŠ” ìƒì„±ëœ ëŒ€ì¹­ í‚¤ë¥¼ ê°€ì ¸ì˜¤ê³  ì€í–‰ ê³µê°œ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”í•©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/bank-server-access-3.png?raw=true)

ì´ì œ ì´ ì•”í˜¸í™”ëœ ì²­í¬ëŠ” ì±„ë„ì„ í†µí•´ ì „ì†¡ë˜ë©° ìŠ¤ë‹ˆí¼ê°€ ì´ë¯¸ ì•”í˜¸í™”ëœ ì²­í¬ì˜ ë³µì‚¬ë³¸ì„ ê°€ì§€ê³  ìˆë‹¤ê³  ê°€ì •í•˜ì§€ë§Œ ìŠ¤ë‹ˆí¼ëŠ” ê°œì¸ í‚¤ê°€ ì•„ë‹Œ ì€í–‰ ì„œë²„ ê³µê°œ í‚¤ë§Œ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— ì•„ë¬´ ê²ƒë„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ì€í–‰ì€ ì•”í˜¸í™”ëœ ì²­í¬ë¥¼ ìˆ˜ì‹ í•˜ê³  ì€í–‰ ì„œë²„ ê°œì¸ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•˜ê³  í˜¸ìŠ¤íŠ¸ì˜ ëŒ€ì¹­ í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/bank-server-access-4.png?raw=true)

ê·¸ëŸ¬ë‚˜ FMEëŠ” ì´ íŠ¸ë¦­ì„ ì´í•´í•©ë‹ˆë‹¤. ê·¸ëŠ” ì€í–‰ ì›¹ì‚¬ì´íŠ¸ì˜ ì •í™•í•œ ë³µì œë³¸ì„ ì œì‹œí•˜ê³  ì‚¬ìš©ìì—ê²Œ ìê²© ì¦ëª…ì„ ì…ë ¥í•˜ë„ë¡ ìš”ì²­í•©ë‹ˆë‹¤. ê·¸ëŠ” ì‚¬ìš©ìê°€ ì›¹ ì‚¬ì´íŠ¸ê°€ í•©ë²•ì ì´ë¼ê³  ìƒê°í•˜ê¸°ë¥¼ ì›í•˜ë¯€ë¡œ ìì‹ ì˜ ê³µê°œ ë° ê°œì¸ í‚¤ ìŒì„ ìƒì„±í•˜ê³  ìì‹ ì˜ ì„œë²„ì—ì„œ êµ¬ì„±í•˜ê³  ì‹¤ì œ ì€í–‰ ì„œë²„ì—ì„œ ìš”ì²­ì„ ìì‹ ì˜ ì„œë²„ë¡œ ë‹¤ì‹œ ë¼ìš°íŒ…í•˜ê¸° ìœ„í•´ ì‚¬ìš©ì í™˜ê²½ì„ ì¡°ì •í•©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/certificate.png?raw=true)

í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” ì‹¤ì œë¡œ ì´ ìŠ¤ë‹ˆí¼ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ì„œë²„ê°€ ë³´ë‚´ëŠ” í‚¤ëŠ” ì¸ì¦ì„œ ë‚´ì— í¬í•¨ë©ë‹ˆë‹¤. ì‹¤ì œ ì¸ì¦ì„œì´ì§€ë§Œ ë””ì§€í„¸ í˜•ì‹ì…ë‹ˆë‹¤. ë‹¹ì—°íˆ ì¸ì¦ì„œëŠ” ì„œëª…ë˜ì§€ë§Œ ì´ê²ƒì´ ì„œë²„ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê±°ë‚˜ ë¬´íš¨í™”í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

> **CERTIFICATES**
>
> ì¸ì¦ì„œì—ëŠ” ì›¹ ì‚¬ì´íŠ¸ì— ëŒ€í•œ ëª¨ë“  ë“±ë¡ëœ ë³„ì¹­, ì„œë²„ ìœ„ì¹˜ ë° ê¸°íƒ€ ì—¬ëŸ¬ ì •ë³´ ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤. ë¬´ì—‡ë³´ë‹¤ë„ FEM ì—”í„°í‹°ê°€ ìƒì„±í•œ ì¸ì¦ì„œëŠ” ìì²´ ì„œëª…ë˜ë©° ì¸ì¦ ê¸°ê´€ì—ì„œ ì„œëª…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
>
> ì‚¬ì‹¤, ë¸Œë¼ìš°ì €ëŠ” ì‚¬ì´íŠ¸ì˜ ë¶ˆì•ˆì •ì„±ì— ëŒ€í•´ ê²½ê³ í•˜ê¸° ìœ„í•´ ì£¼ì†Œ í‘œì‹œì¤„ì— 'ì•ˆì „í•˜ì§€ ì•ŠìŒ'ì„ ì§ì ‘ í‘œì‹œí•˜ëŠ” ìš°ë¦¬ë¥¼ ìœ„í•´ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
>
> CERTIFICATE AUTHORITIES ë˜ëŠ” CAëŠ” ì¸ì¦ì„œì— ì„œëª…í•˜ê³  ìœ íš¨ì„±ì„ ê²€ì‚¬í•  ìˆ˜ ìˆëŠ” ì˜ ì•Œë ¤ì§„ ì¡°ì§ì…ë‹ˆë‹¤. ì¸ê¸°ìˆëŠ” ê²ƒì€ 'Symmantec', 'GlobalSign', 'DigiCert'ì…ë‹ˆë‹¤.
>
> **ì¸ì¦ì„œ ìƒì„± ê³¼ì •**
>
> 1. ë¨¼ì € ìƒì„±ëœ ê³µê°œ í‚¤ëŠ” 'Certificate Signing Request'(CSR)ë¼ëŠ” í•­ëª©ì„ ë§Œë“œëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
>
>    ```bash
>    > openssl req -new \
>    	-key my-bank.key \
>    	-out my.bank.csr \
>    	-subj "/C=US/ST=CA/O=MyOrg, Inc./CN=mydomain.com"
>    my-bank.key my-bank.csr
>    ```
>
> 2. ê·¸ëŸ° ë‹¤ìŒ CAëŠ” ì •ë³´ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³  í™•ì¸ë˜ë©´ ì¸ì¦ì„œì— ì„œëª…í•˜ê³  CSRì„ ë³´ë‚´ëŠ” ì—”í„°í‹°ë¡œ ë‹¤ì‹œ ë³´ëƒ…ë‹ˆë‹¤.

ìŠ¤ë‹ˆí¼ì˜ CSRì€ ê²€ì¦ ë‹¨ê³„ ìì²´ì—ì„œ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ë¸Œë¼ìš°ì €ëŠ” ì¸ì¦ì„œì˜ CA ì„œëª…ì„ ì–´ë–»ê²Œ í™•ì¸í•©ë‹ˆê¹Œ?

CAì—ëŠ” ê°ê° ê³ ìœ í•œ ê³µê°œ í‚¤ì™€ ê°œì¸ í‚¤ê°€ ìˆìŠµë‹ˆë‹¤. CAì˜ ê³µê°œ í‚¤ëŠ” ì´ë¯¸ ë¸Œë¼ìš°ì €ì— ë‚´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë£¨íŠ¸ ì¸ì¦ ê¸°ê´€ ë‚´ì˜ ì¸ì¦ì„œë¥¼ ì‹¤ì œë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. CAëŠ” ê°œì¸ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œì— ì„œëª…í•©ë‹ˆë‹¤. ê° CAì˜ ê³µê°œ í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì¸ì¦ì„œ ìì²´ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ í”„ë¡œì„¸ìŠ¤ëŠ” ê³µê°œ ì›¹ ì‚¬ì´íŠ¸ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. ë¹„ê³µê°œ í˜¸ìŠ¤íŒ… ì›¹ ì‚¬ì´íŠ¸ëŠ” ì–´ë–»ìŠµë‹ˆê¹Œ?

ìœ„ì—ì„œ ì–¸ê¸‰í•œ ëŒ€ë¶€ë¶„ì˜ CAì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” 'ì˜¨í”„ë ˆë¯¸ìŠ¤' ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ CAë¥¼ ì˜¨í”„ë ˆë¯¸ìŠ¤ ì„œë²„ì— ë°°í¬í•˜ë©´ ì¸ì¦ì„œë¥¼ ê²€ì¦í•˜ê³  ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì´ëŸ¬í•œ ê°œì¸ CAëŠ” ê³µê°œ ë° ê°œì¸ í‚¤ë¥¼ ìƒì„±í•˜ê³  ì´ëŸ¬í•œ CAì˜ ê³µê°œ í‚¤ëŠ” ì—°ê²°ëœ ì§ì›ì˜ ë¸Œë¼ìš°ì €ì— ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜ë©ë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ ëŒ€ ì„œë²„ ê´€ì ì—ì„œ ì€í–‰ ì„œë²„ ì¸ì¦ì´ ì–´ë–»ê²Œ ë³´ì´ëŠ”ì§€ì…ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/bank-server-access-5.png?raw=true)

> *ê·¸ëŸ¬ë‚˜ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì€ ì„œë²„ ëŒ€ í´ë¼ì´ì–¸íŠ¸ ê´€ì ì—ì„œ ì–´ë–»ê²Œ ë³´ì¼ê¹Œìš”?*
>
> í´ë¼ì´ì–¸íŠ¸ëŠ” ë˜í•œ ì€í–‰ ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” ê³µê°œ í‚¤ë¡œ CSRì„ ìƒì„±í•˜ì—¬ ìš”ì²­ì´ í•©ë²•ì ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
>
> ![](https://github.com/aditya109/learning-k8s/blob/main/assets/bank-server-access-6.png?raw=true)

ì¸ì¦ êµ¬ì¶•ì— ì‚¬ìš©ë˜ëŠ” ì´ ì „ì²´ ì¸í”„ë¼ë¥¼ **ê³µê°œ í‚¤ êµ¬ì¡°(PKI)**ë¼ê³  í•©ë‹ˆë‹¤.

#### í‚¤ ëª…ëª… ê·œì¹™

ê³µê°œ í‚¤ì—ëŠ” `*.crt` ë˜ëŠ” `*.pem` í™•ì¥ìê°€ ìˆìŠµë‹ˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´,

```bash
server.crt
server.pem
client.crt
client.pem
```

ê°œì¸ í‚¤ì—ëŠ” `*.key` ë˜ëŠ” `*-key.pem` í™•ì¥ìê°€ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,

```bash
server.key
server-key.pem
client.key
client-key.pem
```

### TLS in Kubernetes

#### ì„œë²„ìš© ì¸ì¦ì„œ

*í´ëŸ¬ìŠ¤í„° ì„¤ì •ì— ë”°ë¼ ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.*

| Component       | Certificate (Public Key) | Private Key    |      |
| --------------- | ------------------------ | -------------- | ---- |
| kube-api-server | apiserver.crt            | apiserver.key  |      |
| etcd-server     | etcdserver.crt           | etcdserver.key |      |
| kubelet-server  | kubelet.crt              | kubelet.key    |      |

#### í´ë¼ì´ì–¸íŠ¸ìš© ì¸ì¦ì„œ

*í´ëŸ¬ìŠ¤í„° ì„¤ì •ì— ë”°ë¼ ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.*

| Component                                         | Certificate (Public Key)     | Private Key                  |
| ------------------------------------------------- | ---------------------------- | ---------------------------- |
| admin (for `kubectl` REST API)                    | admin.crt                    | admin.key                    |
| kube-scheduler  (for `kubectl` REST API)          | scheduler.crt                | scheduler.key                |
| kube-controller-manager  (for `kubectl` REST API) | controller-manager.crt       | controller-manager.key       |
| kube-proxy  (for `kubectl` REST API)              | kube-proxy.crt               | kube-proxy.key               |
| kube-api-server (for talking to etcd-server)      | apiserver-etcd-client.crt    | apiserver-etcd-client.key    |
| kube-api-server (for talking to kublet-server)    | apiserver-kubelet-client.crt | apiserver-kubelet-client.key |
| kubelet-server (as a client)                      | kubelet-client.crt           | kubelet-client.key           |

CAëŠ” ë˜í•œ ìì²´ `ca.crt` ë° `ca.key`ê°€ ìˆëŠ” Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

## TLS in Kubernetes - Certificate Creation

ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ë ¤ë©´ ë‹¤ìŒ ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- EASYRSA
- OPENSSL
- CFSSL

### TLS Certificate Generation

**Kubernetes CA**

Step 1: Kubernetes CAìš© **ê°œì¸ í‚¤ë¥¼ ìƒì„±**í•©ë‹ˆë‹¤.

```bash
> openssl genrsa -out ca.key 2048
ca.key
```

Step 2: Kubernetes CAì— ëŒ€í•œ **CSRì„ ìƒì„±**í•©ë‹ˆë‹¤.

```bash
> openssl req -new -key ca.key -subj "/CN=KUBERNETES-CA" -out ca.csr
ca.csr
```

Step 3: 1ë‹¨ê³„ì—ì„œ ìƒì„±í•œ `ca.key`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œì— ì„œëª…í•©ë‹ˆë‹¤.

```bash
> openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt
ca.crt
```

**Admin User**

Step 4: ê´€ë¦¬ ì‚¬ìš©ìë¥¼ ìœ„í•œ **ê°œì¸ í‚¤ë¥¼ ìƒì„±**í•©ë‹ˆë‹¤.

```bash
> openssl genrsa -out admin.key 2048
admin.key
```

Step 5: Kubernetes CAì— ëŒ€í•œ **CSRì„ ìƒì„±**í•©ë‹ˆë‹¤.

```bash
> openssl req -new \
				-key admin.key \
				-subj "/CN=kube-admin/O=system:masters" \ 
# the above O=system:masters specifies the group to which the client belongs to
				-out admin.csr
admin.csr
```

Step 6: 1ë‹¨ê³„ì—ì„œ ìƒì„±í•œ `ca.key`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œì— ì„œëª…í•©ë‹ˆë‹¤

```bash
> openssl x509 -req -in admin.csr -CA ca.key -CAkey ca.key -out admin.crt
admin.crt
```

> ë™ì¼í•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¼ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
>
> kube-controlplane êµ¬ì„± ìš”ì†Œì˜ ê²½ìš° 5ë‹¨ê³„ì˜ ì´ë¦„ì— `system:` ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `kube-proxy`ì˜ ê²½ìš°ì…ë‹ˆë‹¤.
>
> ```bash
> > openssl req -new \
> 				-key admin.key \
> 				-subj "/CN=system:kube-proxy/O=system:masters" \ 
> # the above O=system:masters specifies the group to which the client belongs to
> 				-out admin.csr
> admin.csr
> ```

ê·¸ëŸ¬ë‚˜ ê´€ë¦¬ì ì¸ì¦ì„œ ìƒì„±ìœ¼ë¡œ ë¬´ì—‡ì„ í•´ì•¼ í•©ë‹ˆê¹Œ?

`admin.key`, `admin.crt` ë° `ca.crt`ë¥¼ ì‚¬ìš©í•˜ì—¬ `kube-api-server`ì— ì§ì ‘ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
curl https://kube-apiserver:6443/api/v1/pods \	
		--key admin.key \
		--cert admin.crt \
		--cacert ca.crt
```

í´ëŸ¬ìŠ¤í„° ì„¤ì • ë‚´ì—ì„œ `kube-config.yaml`ì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority: ca.crt
    server: https://kube-apiserver:6443
  name: kubernetes
kind: Config
users:
- name: kubernetes-admin
  user:
    client-certificate: admin.crt
    client-key: admin.key
```

Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  êµ¬ì„± ìš”ì†Œ ë‚´ì— `ca.crt`ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

`etcd` í´ëŸ¬ìŠ¤í„°ì—ëŠ” ì¼ë°˜ì ìœ¼ë¡œ `etcd.yaml`ì—ì„œ ì œê³µë˜ëŠ” P2P ê²€ì¦ì„ ìœ„í•´ ë°°í¬ëœ ë³„ë„ì˜ CAê°€ ìˆìŠµë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/etcd.png?raw=true)

`kube-api-server`ì™€ ë³„ì¹­ì€ ì–´ë–»ìŠµë‹ˆê¹Œ?

ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ë³„ì¹­ì€ `kubernetes`, `kubernetes.default`, `kubernetes.default.svc` ë° `kubernetes.default.svc.cluster.local`ì…ë‹ˆë‹¤. ë˜í•œ ë§ì€ ì‚¬ëŒë“¤ì´ IP ì£¼ì†Œë¡œë„ ì°¸ì¡°í•©ë‹ˆë‹¤. ëª¨ë‘ ì¸ì¦ì„œì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ë³„ì¹­ì€ ì–´ë–»ìŠµë‹ˆê¹Œ?

ì´ë¥¼ ìœ„í•´ `openssl`ì— ëŒ€í•œ êµ¬ì„± íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

```yaml
[req]
req_extensions = v3_req
[v3_req]
basicContraints = CA:FALSE
keyUsage = nonRepudiation
subjectAltName = @alt_names
[alt_names]
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.cluster.local
IP.1 = 10.96.0.1
IP.2 = 172.17.0.87
```



```bash
# generate the private key
> openssl genrsa -out apiserver.key 2048
apiserver.key

# generate the CSR
> openssl req -new \
			-key apiserver.key \
			-subj "/CN=kube-apiserver" \
			-out apiserver.csr
			--config openssl.cnf ğŸ‘ˆ
apiserver.csr

# generate the certificate
openssl x509 -req \
			-in apiserver.csr \
			-CA ca.crt \
			-CAkey ca.key \
            -out apiserver.crt
 apiserver.crt
```

ì´ëŸ¬í•œ ì•„í‹°íŒ©íŠ¸ì˜ ìœ„ì¹˜ëŠ” `kube-api-server` ìƒì„± ìƒì„± ì‹œ ì „ë‹¬ë©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/kuebapiserver.png?raw=true)

ì´ì œ `kubelet` ì„œë²„ ì¸ì¦ì„œìš©ì…ë‹ˆë‹¤. ì„œë²„ì˜ CSRì— ì „ë‹¬ë˜ëŠ” ì´ë¦„ì€ `kubelet`ì´ ì•„ë‹Œ ê° ë…¸ë“œì˜ ì´ë¦„ê³¼ ë™ì¼í•˜ë©° ìµœì¢…ì ìœ¼ë¡œ `kubelet` êµ¬ì„± íŒŒì¼ì— ì „ë‹¬ë©ë‹ˆë‹¤.

```yaml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io./v1beta1
authentication:
  x509:
    clientCAFile: "/var/lib/kubernetes/ca.pem"
authorization:
  mode: Webhook
clusterDomain: "cluster.local"
clusterDNS:
  - "10.32.0.10"
podCIDR: "${POD_CIDR}"
resolvConf: "/run/systemd/resolve/resolv.conf"
runtimeRequestTimeout: "15m"
tlsCertFile: "/var/lib/kubelet/kubelet-node01.crt"
tlsPrivateKeyFile: "/var/lib/kubelet/kubelet-node01.key"
```

**Client Certificates for `kubelet`**

ì´ëŠ” `kubelet`ì—ì„œ `kube-apiserver`ë¥¼ ì¸ì¦í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì¸ì¦ì„œì—ëŠ” ê·¸ë£¹ì´ `SYSTEM:NODES`ì¸ `system:node:node01` í˜•ì‹ì˜ ë…¸ë“œ ì´ë¦„ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

## View Certificate Details

### ì¸ì¦ì„œ ìƒíƒœ í™•ì¸ ìˆ˜í–‰

1. ë¨¼ì € í´ëŸ¬ìŠ¤í„°ê°€ ì–´ë–»ê²Œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

   1. *the hard way* - `cat /etc/systemd/system/kube-apiserver.service`
   2. *using kubeadm* - `cat /etc.kubernetes/manifests/kube-apiserver.yaml`

2. í´ëŸ¬ìŠ¤í„°ì—ì„œ í•„ìš”í•œ ì¸ì¦ì„œì˜ ìœ„ì¹˜ë¥¼ â€‹â€‹ì°¾ìŠµë‹ˆë‹¤.

   | Component        |        Type        | Certificate Path | CN Name | ALT Name | Organization | Issuer | Expiration |
   | ---------------- | :----------------: | :--------------: | :-----: | :------: | ------------ | ------ | ---------- |
   | `kube-apiserver` |       Server       |                  |         |          |              |        |            |
   | `kube-apiserver` |       Server       |                  |         |          |              |        |            |
   | `kube-apiserver` |       Server       |                  |         |          |              |        |            |
   | `kube-apiserver` | Client (`kubelet`) |                  |         |          |              |        |            |
   | `kube-apiserver` | Client (`kubelet`) |                  |         |          |              |        |            |
   | `kube-apiserver` |  Client (`etcd`)   |                  |         |          |              |        |            |
   | `kube-apiserver` |  Client (`etcd`)   |                  |         |          |              |        |            |
   | `kube-apiserver` |  Client (`etcd`)   |                  |         |          |              |        |            |

```yaml
# kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kube-apiserver
    tier: control-plane
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - /bin/sh
    - -c
    - exec /usr/local/bin/kube-apiserver --v=2
      --cloud-config=/etc/gce.conf
      --address=127.0.0.1
      --allow-privileged=true
      --cloud-provider=gce
      # ğŸ‘‡
      --client-ca-file=/etc/srv/kubernetes/pki/ca-certificates.crt 
      --etcd-servers=http://127.0.0.1:2379
      --etcd-servers-overrides=/events#http://127.0.0.1:4002
      --secure-port=443
      # ğŸ‘‡
      --tls-cert-file=/etc/srv/kubernetes/pki/apiserver.crt 
      # ğŸ‘‡
      --tls-private-key-file=/etc/srv/kubernetes/pki/apiserver.key 
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
      --requestheader-client-ca-file=/etc/srv/kubernetes/pki/aggr_ca.crt
      --requestheader-allowed-names=aggregator
      --requestheader-extra-headers-prefix=X-Remote-Extra-
      --requestheader-group-headers=X-Remote-Group
      --requestheader-username-headers=X-Remote-User
      --proxy-client-cert-file=/etc/srv/kubernetes/pki/proxy_client.crt
      --proxy-client-key-file=/etc/srv/kubernetes/pki/proxy_client.key
      --enable-aggregator-routing=true
      --tls-cert-file=/etc/srv/kubernetes/pki/apiserver.crt
      --tls-private-key-file=/etc/srv/kubernetes/pki/apiserver.key
      # ğŸ‘‡
      --kubelet-client-certificate=/etc/srv/kubernetes/pki/apiserver-client.crt  	   
      # ğŸ‘‡
      --kubelet-client-key=/etc/srv/kubernetes/pki/apiserver-client.key
      --service-account-key-file=/etc/srv/kubernetes/pki/serviceaccount.crt
      --token-auth-file=/etc/srv/kubernetes/known_tokens.csv
      --basic-auth-file=/etc/srv/kubernetes/basic_auth.csv
      --storage-backend=etcd3
      --storage-media-type=application/vnd.kubernetes.protobuf
      --etcd-compaction-interval=150s
      --target-ram-mb=180
      --service-cluster-ip-range=10.51.240.0/20
      --audit-policy-file=/etc/audit_policy.config
      --audit-webhook-mode=batch
      --audit-webhook-config-file=/etc/audit_webhook.config
      --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ExtendedResourceToleration,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota
      --runtime-config=api/all=true
      --advertise-address=33.3.3.3
      --ssh-user=zorp
      --ssh-keyfile=/etc/srv/sshproxy/.sshkeyfile
      --authentication-token-webhook-config-file=/etc/gcp_authn.config
      --authorization-webhook-config-file=/etc/gcp_authz.config
      --authorization-mode=Node,RBAC,Webhook
      --allow-privileged=true 1>>/var/log/kube-apiserver.log
      2>&1
    image: k8s.gcr.io/kube-apiserver:v1.9.7
    ... 
    ...
```

`kube-apiserver` ì˜ ì„œë²„ ì¸ì¦ì„œë¥¼ í•´ë…í•´ ë´…ì‹œë‹¤.

```bash
> openssl x509 -in /etc/srv/kubernetes/pki/apiserver.crt -text -noout
```

ë‹¤ìŒ í•„ë“œì— ìœ ì˜í•˜ì‹­ì‹œì˜¤.

- `Certificate` > `Signature Algorithm` > `Validity` : `Not After`
- `Certificate` > `Signature Algorithm` > `Subject`
- `Certificate` > `Signature Algorithm` > `X509v3 extensions` > `X509v3 Subject Alternative Name`
- `Certificate` > `Signature Algorithm` > `Issuer`

**Inspect Service Logs**

```powershell
> journalctl -u etcd.service -l # for from scratch setup 
```

**View Logs** 

```powershell
> kubectl logs etcd-master # for `kubeadm` setup
```

> ê²½ìš°ì— ë”°ë¼ `kube-apiserver`, `etcd-server`ì™€ ê°™ì€ í•µì‹¬ êµ¬ì„± ìš”ì†Œê°€ ë‹¤ìš´ë˜ë©´ `kubectl` ëª…ë ¹ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
>
> ê·¸ëŸ° ë‹¤ìŒ dockerì— ëŒ€í•´ í•œ ìˆ˜ì¤€ ë” ê¹Šì´ íŒŒê³ ë“¤ì–´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
>
> ```powershell
> > docker ps -a # list all the containers
> > docker logs <pod-name>
> ```
>

## Certificates API and Workflow

ì¸ì¦ì„œ APIëŠ” CA ì„œë²„ì—ì„œ CSRì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•  ë•Œ ì¸ì¦ì„œì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
ì´ê²ƒì€ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ê³  ê¶Œí•œì„ ì œê³µí•˜ê¸° ìœ„í•œ ê¸°ë³¸ ì œê³µ ìë™í™” ì†”ë£¨ì…˜ì…ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆì„ ê²ƒì…ë‹ˆë‹¤.

ì¸ì¦ì„œì— ì„œëª…í•˜ë ¤ë©´ CSRì„ ìˆ˜ì‹ í•  ë•Œë§ˆë‹¤ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

1. A CSR is received.

   ```bash
   > openssl genrsa -out jane.key 2048
   jane.key
   > openssl req 
   			-new \
   			-key jane.key \
   			-subj "/CN=jane" \
   			-out jane.csr
   jane.csr			
   > cat jane.csr
   -----BEGIN CERTIFICATE REQUEST-----
   MIICVDCCATwCAQAwDzENMAsGA1UEAwwEamFuZTCCASIwDQYJKoZIhvcNAQEBBQAD
   ggEPADCCAQoCggEBAJybaAAaSUysnz6D0TGLs8p8Zmew9+2FH+A59pj1SSt5V8Mg
   XjENC7/BYpSLzEueKsFqiew7MntuUKuJaK1tHwNaUGhOzLgqcdTTenZxi7kPmTdK
   cbaxbz859d7v/T7I8BjE0EuL5VNkonwoqN69BNtMmJJOCzlvhFWDQLM/aNW1qER0
   6zeLmbJv9la5g8jixLpLYBeuAvPm6RBkO4ncmENbboGma9/XBM/xVgviUAAqHUJX
   AQOrhuaZSw0mKZByL/aOo85n0iBWWexB8GImFyIQOaamkUfAlnItT7k7l6odWglb
   hUB7HuidMFL5edf7dWFUqzSBzQYIfedT20NovE8CAwEAAaAAMA0GCSqGSIb3DQEB
   CwUAA4IBAQAdGIiJY8LQqtvST2VcZwQNCVb/Pblj9cGRhNSxAf3VYVLsmxe9k+S7
   qXB20kEeSpN9VO0PG68bYqs+oeygemgaes5OUKZQFXU8W+OeUoN8H5F0pAmVSEcK
   Ywzmd1oiMB85q8u99L6HTr1OQjgP1shT/MqzyAkN8CNn8CQACjiVs3Go0lvSX76V
   59DjTphnhisRAb1KWN5ctUL46bo+HNf3vsXFSNdACcSuJm7Wjf4s2GDcjno9EarQ
   VfAmnQxedRHif+bJ5YogkZq+FBq7Aa2P308GYlw7p8wDT2Xuy1K2nyj96de10cp/
   UnQdIXAMV0bvMseYZCVZrVC3CzicB2jA
   -----END CERTIFICATE REQUEST-----
   ```

2. ê·¸ëŸ° ë‹¤ìŒ 'CertificateSigningRequest' ê°ì²´ê°€ ìƒì„±ë˜ë©°, ì—¬ê¸°ì„œ ìœ„ì˜ 'jane.csr'ì€ 'base64' ì¸ì½”ë”© í˜•ì‹ìœ¼ë¡œ ë°°ì¹˜ë©ë‹ˆë‹¤.

   ```bash
   > cat jane.csr | base64
   LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZEQ0NBVHdDQVFBd0R6RU5N
   QXNHQTFVRUF3d0VhbUZ1WlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRApnZ0VQQURDQ0FRb0Nn
   Z0VCQUp5YmFBQWFTVXlzbno2RDBUR0xzOHA4Wm1ldzkrMkZIK0E1OXBqMVNTdDVWOE1nClhqRU5D
   Ny9CWXBTTHpFdWVLc0ZxaWV3N01udHVVS3VKYUsxdEh3TmFVR2hPekxncWNkVFRlblp4aTdrUG1U
   ZEsKY2JheGJ6ODU5ZDd2L1Q3SThCakUwRXVMNVZOa29ud29xTjY5Qk50TW1KSk9Demx2aEZXRFFM
   TS9hTlcxcUVSMAo2emVMbWJKdjlsYTVnOGppeExwTFlCZXVBdlBtNlJCa080bmNtRU5iYm9HbWE5
   L1hCTS94Vmd2aVVBQXFIVUpYCkFRT3JodWFaU3cwbUtaQnlML2FPbzg1bjBpQldXZXhCOEdJbUZ5
   SVFPYWFta1VmQWxuSXRUN2s3bDZvZFdnbGIKaFVCN0h1aWRNRkw1ZWRmN2RXRlVxelNCelFZSWZl
   ZFQyME5vdkU4Q0F3RUFBYUFBTUEwR0NTcUdTSWIzRFFFQgpDd1VBQTRJQkFRQWRHSWlKWThMUXF0
   dlNUMlZjWndRTkNWYi9QYmxqOWNHUmhOU3hBZjNWWVZMc214ZTlrK1M3CnFYQjIwa0VlU3BOOVZP
   MFBHNjhiWXFzK29leWdlbWdhZXM1T1VLWlFGWFU4VytPZVVvTjhINUYwcEFtVlNFY0sKWXd6bWQx
   b2lNQjg1cTh1OTlMNkhUcjFPUWpnUDFzaFQvTXF6eUFrTjhDTm44Q1FBQ2ppVnMzR28wbHZTWDc2
   Vgo1OURqVHBobmhpc1JBYjFLV041Y3RVTDQ2Ym8rSE5mM3ZzWEZTTmRBQ2NTdUptN1dqZjRzMkdE
   Y2pubzlFYXJRClZmQW1uUXhlZFJIaWYrYko1WW9na1pxK0ZCcTdBYTJQMzA4R1lsdzdwOHdEVDJY
   dXkxSzJueWo5NmRlMTBjcC8KVW5RZElYQU1WMGJ2TXNlWVpDVlpyVkMzQ3ppY0IyakEKLS0tLS1F
   TkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==
   ```

   ```yaml
   # jane-key.csr
   apiVersion: certificates.k8s.io/v1
   kind: CertificateSigningRequest
   metadata:
     name: jane
   spec:
     groups:
     - system:authenticated
     usages:
     - digital signature
     - key encipherment
     - server auth
     request:
       LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZEQ0NBVHdDQVFBd0R6RU5NQXNHQTFVRUF3d0VhbUZ1WlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRApnZ0VQQURDQ0FRb0NnZ0VCQUp5YmFBQWFTVXlzbno2RDBUR0xzOHA4Wm1ldzkrMkZIK0E1OXBqMVNTdDVWOE1nClhqRU5DNy9CWXBTTHpFdWVLc0ZxaWV3N01udHVVS3VKYUsxdEh3TmFVR2hPekxncWNkVFRlblp4aTdrUG1UZEsKY2JheGJ6ODU5ZDd2L1Q3SThCakUwRXVMNVZOa29ud29xTjY5Qk50TW1KSk9Demx2aEZXRFFMTS9hTlcxcUVSMAo2emVMbWJKdjlsYTVnOGppeExwTFlCZXVBdlBtNlJCa080bmNtRU5iYm9HbWE5L1hCTS94Vmd2aVVBQXFIVUpYCkFRT3JodWFaU3cwbUtaQnlML2FPbzg1bjBpQldXZXhCOEdJbUZ5SVFPYWFta1VmQWxuSXRUN2s3bDZvZFdnbGIKaFVCN0h1aWRNRkw1ZWRmN2RXRlVxelNCelFZSWZlZFQyME5vdkU4Q0F3RUFBYUFBTUEwR0NTcUdTSWIzRFFFQgpDd1VBQTRJQkFRQWRHSWlKWThMUXF0dlNUMlZjWndRTkNWYi9QYmxqOWNHUmhOU3hBZjNWWVZMc214ZTlrK1M3CnFYQjIwa0VlU3BOOVZPMFBHNjhiWXFzK29leWdlbWdhZXM1T1VLWlFGWFU4VytPZVVvTjhINUYwcEFtVlNFY0sKWXd6bWQxb2lNQjg1cTh1OTlMNkhUcjFPUWpnUDFzaFQvTXF6eUFrTjhDTm44Q1FBQ2ppVnMzR28wbHZTWDc2Vgo1OURqVHBobmhpc1JBYjFLV041Y3RVTDQ2Ym8rSE5mM3ZzWEZTTmRBQ2NTdUptN1dqZjRzMkdEY2pubzlFYXJRClZmQW1uUXhlZFJIaWYrYko1WW9na1pxK0ZCcTdBYTJQMzA4R1lsdzdwOHdEVDJYdXkxSzJueWo5NmRlMTBjcC8KVW5RZElYQU1WMGJ2TXNlWVpDVlpyVkMzQ3ppY0IyakEKLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==
     signerName: kubernetes.io/kube-apiserver-client
   ```

   > ëª¨ë“  `CertificateSigningRequest`ëŠ” ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   ```bash
   > kubectl create -f jane-key.csr
   certificatesigningrequest.certificates.k8s.io/jane created
   
   > kubectl get csr
   ```

   | NAME | AGE  | SIGNERNAME                          | REQUESTOR          | CONDITION |
   | ---- | ---- | ----------------------------------- | ------------------ | --------- |
   | jane | 59s  | kubernetes.io/kube-apiserver-client | docker-for-desktop | Pending   |

3. ìš”ì²­ì„ ê²€í† í•˜ê³  ìŠ¹ì¸/ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   ```bash
   > kubectl certificate approve jane
   certificatesigningrequest.certificates.k8s.io/jane approved
   > kubectl certificate deny jane
   certificatesigningrequest.certificates.k8s.io/jane denied
   ```

4. ê·¸ëŸ¬ë©´ ì¸ì¦ì„œê°€ ì‚¬ìš©ìì—ê²Œ ë‹¤ì‹œ ê³µìœ ë©ë‹ˆë‹¤.

   ```bash
   > kubectl get csr jane -o yaml
    kubectl get csr jane -o yaml
   apiVersion: certificates.k8s.io/v1
   kind: CertificateSigningRequest
   metadata:
     creationTimestamp: "2021-08-01T14:16:30Z"
     name: jane
     resourceVersion: "31198"
     uid: 466161d6-a21d-482d-b75f-fed4ecea5735
   spec:
     groups:
     - system:masters
     - system:authenticated
     request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZEQ0NBVHdDQVFBd0R6RU5NQXNHQTFVRUF3d0VhbUZ1WlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRApnZ0VQQURDQ0FRb0NnZ0VCQUp5YmFBQWFTVXlzbno2RDBUR0xzOHA4Wm1ldzkrMkZIK0E1OXBqMVNTdDVWOE1nClhqRU5DNy9CWXBTTHpFdWVLc0ZxaWV3N01udHVVS3VKYUsxdEh3TmFVR2hPekxncWNkVFRlblp4aTdrUG1UZEsKY2JheGJ6ODU5ZDd2L1Q3SThCakUwRXVMNVZOa29ud29xTjY5Qk50TW1KSk9Demx2aEZXRFFMTS9hTlcxcUVSMAo2emVMbWJKdjlsYTVnOGppeExwTFlCZXVBdlBtNlJCa080bmNtRU5iYm9HbWE5L1hCTS94Vmd2aVVBQXFIVUpYCkFRT3JodWFaU3cwbUtaQnlML2FPbzg1bjBpQldXZXhCOEdJbUZ5SVFPYWFta1VmQWxuSXRUN2s3bDZvZFdnbGIKaFVCN0h1aWRNRkw1ZWRmN2RXRlVxelNCelFZSWZlZFQyME5vdkU4Q0F3RUFBYUFBTUEwR0NTcUdTSWIzRFFFQgpDd1VBQTRJQkFRQWRHSWlKWThMUXF0dlNUMlZjWndRTkNWYi9QYmxqOWNHUmhOU3hBZjNWWVZMc214ZTlrK1M3CnFYQjIwa0VlU3BOOVZPMFBHNjhiWXFzK29leWdlbWdhZXM1T1VLWlFGWFU4VytPZVVvTjhINUYwcEFtVlNFY0sKWXd6bWQxb2lNQjg1cTh1OTlMNkhUcjFPUWpnUDFzaFQvTXF6eUFrTjhDTm44Q1FBQ2ppVnMzR28wbHZTWDc2Vgo1OURqVHBobmhpc1JBYjFLV041Y3RVTDQ2Ym8rSE5mM3ZzWEZTTmRBQ2NTdUptN1dqZjRzMkdEY2pubzlFYXJRClZmQW1uUXhlZFJIaWYrYko1WW9na1pxK0ZCcTdBYTJQMzA4R1lsdzdwOHdEVDJYdXkxSzJueWo5NmRlMTBjcC8KVW5RZElYQU1WMGJ2TXNlWVpDVlpyVkMzQ3ppY0IyakEKLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==
     signerName: kubernetes.io/kube-apiserver-client
     usages:
     - digital signature
     - key encipherment
     - server auth
     username: docker-for-desktop
   status:
     conditions:
     - lastTransitionTime: "2021-08-01T14:19:35Z"
       lastUpdateTime: "2021-08-01T14:19:36Z"
       message: This CSR was approved by kubectl certificate approve.
       reason: KubectlApprove
       status: "True"
       type: Approved
     - lastTransitionTime: "2021-08-01T14:19:35Z"
       lastUpdateTime: "2021-08-01T14:19:35Z"
       message: 'invalid usage for client certificate: server auth'
       reason: SignerValidationFailure
       status: "True"
       type: Failed
   ```

   The `request` field value here ca819710819710n be extracted off and decoded to `base64`, which can be shared to the respective by the user.

   ```bash
   >  echo LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZEQ0NBVHdDQVFBd0R6RU5NQXNHQTFVRUF3d0V......hlZFJIaWYrYko1WW9na1pxK0ZCcTdBYTJQMzA4R1lsdzdwOHdEVDJYdXkxSzJueWo5NmRlMTBjcC8KVW5RZElYQU1WMGJ2TXNlWVpDVlpyVkMzQ3ppY0IyakEKLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg== |base64 --decode
   -----BEGIN CERTIFICATE REQUEST-----
   MIICVDCCATwCAQAwDzENMAsGA1UEAwwEamFuZTCCASIwDQYJKoZIhvcNAQEBBQAD
   ggEPADCCAQoCggEBAJybaAAaSUysnz6D0TGLs8p8Zmew9+2FH+A59pj1SSt5V8Mg
   XjENC7/BYpSLzEueKsFqiew7MntuUKuJaK1tHwNaUGhOzLgqcdTTenZxi7kPmTdK
   cbaxbz859d7v/T7I8BjE0EuL5VNkonwoqN69BNtMmJJOCzlvhFWDQLM/aNW1qER0
   6zeLmbJv9la5g8jixLpLYBeuAvPm6RBkO4ncmENbboGma9/XBM/xVgviUAAqHUJX
   AQOrhuaZSw0mKZByL/aOo85n0iBWWexB8GImFyIQOaamkUfAlnItT7k7l6odWglb
   hUB7HuidMFL5edf7dWFUqzSBzQYIfedT20NovE8CAwEAAaAAMA0GCSqGSIb3DQEB
   CwUAA4IBAQAdGIiJY8LQqtvST2VcZwQNCVb/Pblj9cGRhNSxAf3VYVLsmxe9k+S7
   qXB20kEeSpN9VO0PG68bYqs+oeygemgaes5OUKZQFXU8W+OeUoN8H5F0pAmVSEcK
   Ywzmd1oiMB85q8u99L6HTr1OQjgP1shT/MqzyAkN8CNn8CQACjiVs3Go0lvSX76V
   59DjTphnhisRAb1KWN5ctUL46bo+HNf3vsXFSNdACcSuJm7Wjf4s2GDcjno9EarQ
   VfAmnQxedRHif+bJ5YogkZq+FBq7Aa2P308GYlw7p8wDT2Xuy1K2nyj96de10cp/
   UnQdIXAMV0bvMseYZCVZrVC3CzicB2jA
   -----END CERTIFICATE REQUEST-----
   ```

All the certificate signing operations are performed under `Controller Manager` - which has `CSR-APPROVING` and `CSR-SIGNING` which perform these tasks.

```bash
> cat /etc/kubernetes/manifests/kube-controller-manager.yaml
```

`kube-controller-manager` manifest file has 2 fields with `spec` section :

- `--cluster-signing-cert-file`
- `--cluster-signing-key-file`
