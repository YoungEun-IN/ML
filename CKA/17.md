## Switching and Routing

2ê°œì˜ ì‹œìŠ¤í…œ Aì™€ Bê°€ ìˆë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì„œë¡œ ì–´ë–»ê²Œ í†µì‹ í• ê¹Œìš”?

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/networking-1.svg)

**ìŠ¤ìœ„ì¹˜**ì— ì—°ê²°í•©ë‹ˆë‹¤.
![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/networking-2.svg)

ê° ì‹œìŠ¤í…œì„ ìŠ¤ìœ„ì¹˜ì— ì—°ê²°í•˜ë ¤ë©´ ì¼ì¢…ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‘ ì‹œìŠ¤í…œ ëª¨ë‘ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/networking-3.svg)

```bash
ip link # to view the switch interface name

ip addr add 192.168.1.10/24 dev eth0 # assign the system A to networking interface

ip addr add 192.168.1.11/24 dev eth0 # assign the system B to networking interface
```

> í˜„ì¬ ìŠ¤ìœ„ì¹˜ëŠ” ë…¸ë“œ Aì™€ B ì‚¬ì´ì˜ í†µì‹ ë§Œ ê°€ëŠ¥í•˜ë©° ì™¸ë¶€ íŠ¸ë˜í”½ ì…/ì¶œë ¥ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì„œë¡œ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ì— ìˆëŠ” í˜¸ìŠ¤íŠ¸ Bë¥¼ Cì— ì—°ê²°í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/networking-4.svg)

ì´ë¥¼ ìœ„í•´ì„œëŠ” **ë¼ìš°í„°**ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¼ìš°í„°ì—ëŠ” ê° ìŠ¤ìœ„ì¹˜ í¬íŠ¸ì— í•˜ë‚˜ì”© 2ê°œì˜ IPê°€ í• ë‹¹ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë‘ ìŠ¤ìœ„ì¹˜ ê°„ì˜ í†µì‹ ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/networking-5.svg)

ê·¸ëŸ¬ë‚˜ BëŠ” ì–´ë–»ê²Œ Cì— ë°ì´í„°ë¥¼ ë³´ë‚¼ê¹Œìš”?

ì´ë¥¼ ìœ„í•´ì„œëŠ” **ê²Œì´íŠ¸ì›¨ì´**ë„ í•„ìš”í•©ë‹ˆë‹¤. ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì™€ í†µì‹ í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

ê¸°ì¡´ ë¼ìš°íŒ… í…Œì´ë¸” êµ¬ì„±ì„ ë³´ë ¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
route
```

Bì— ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸ Cë¥¼ ì¶”ê°€í•˜ë ¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
ip route add 192.168.2.0/24 via 192.168.1.1
```

> ëª¨ë“  ëŒ€ìƒ í˜¸ìŠ¤íŠ¸ì— ëŒ€í•´ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

í˜¸ìŠ¤íŠ¸ë¥¼ ì¸í„°ë„· `172.217.194.0/24`ì— ì—°ê²°í•˜ë ¤ë©´ ë¼ìš°í„°ë¥¼ ì¸í„°ë„·ì— ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ìƒˆ ë¼ìš°íŒ… êµ¬ì„±ì„ í˜¸ìŠ¤íŠ¸ì— ì¶”ê°€í•©ë‹ˆë‹¤.

```bash
ip route add 172.217.194.0/24 via 192.168.2.1
```

ì¸í„°ë„·ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¼ìš°íŒ… ì‚¬ì´íŠ¸ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ë™ì¼í•œ ì´ë¦„ì— ì—¬ëŸ¬ ë¼ìš°íŒ… í…Œì´ë¸” í•­ëª©ì„ ì¶”ê°€í•˜ëŠ” ëŒ€ì‹  ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ ip route add default via 192.168.2.1
# or
$ ip route add 0.0.0.0 via 192.168.2.1
```

ì´ì œ í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ì™¸ë¶€ì˜ ëª¨ë“  ìš”ì²­ì€ ë¼ìš°í„°ë¥¼ í†µê³¼í•©ë‹ˆë‹¤.

ë„¤íŠ¸ì›Œí¬ì— í•˜ë‚˜ì˜ ë¼ìš°í„°ë§Œ ìˆì„ ë•Œ ì´ê²ƒì€ ê´œì°®ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì—¬ëŸ¬ ë¼ìš°í„°ê°€ ìˆì„ ë•Œ ì—¬ëŸ¬ ë¼ìš°íŒ… êµ¬ì„±ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

**ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤**: Aë¥¼ Cì— ì–´ë–»ê²Œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/networking-scenario-2.svg)

Aì—ì„œ IP<sub>C</sub>ë¥¼ í•‘í•˜ë©´;

```bash
ping 192.168.2.5
# connect: network is unreachable
```

ë”°ë¼ì„œ Aì—ì„œëŠ” ë¼ìš°íŒ… í…Œì´ë¸”ì— ë¼ìš°íŒ… êµ¬ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.

```bash
ip route add 192.168.2.0/24 via 192.168.1.6
```

Cì—ì„œëŠ” ë¼ìš°íŒ… í…Œì´ë¸”ì— ë¼ìš°íŒ… êµ¬ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.

```bash
ip route add 192.168.1.0/24 via 192.168.2.6
```

ì´ì œ ìš°ë¦¬ëŠ” Aì—ì„œ IP<sub>C</sub>ë¥¼ pingí•  ìˆ˜ ìˆì§€ë§Œ Cì—ì„œ ì‘ë‹µì„ ë°›ì§€ ëª»í•©ë‹ˆë‹¤. ì´ìœ ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Linuxê°€ ë°ì´í„° íŒ¨í‚· ì „ë‹¬ì„ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ë¥¼ í™œì„±í™”í•˜ë ¤ë©´ í˜¸ìŠ¤íŠ¸ Cì—ì„œ `/proc/sys/net/ipv4/ip_forward` íŒŒì¼ì˜ ê°’ì„ 0ì—ì„œ 1ë¡œ ë®ì–´ì”ë‹ˆë‹¤.

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
1
cat /proc/sys/net/ipv4/ip_forward
1
```

> ì´ ë³€ê²½ ì‚¬í•­ì€ ì¬ë¶€íŒ… í›„ì—ë„ ì§€ì†ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ `/etc/sysctl.conf` íŒŒì¼ì—ì„œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
>
> ```bash
> ...
> net.ipv4.ip_forward = 1
> ...
> ```

## DNS

![](https://raw.githubusercontent.com/aditya109/learning-k8s/a5821e04abcc0d86569ad9b827b130a1df3dc7aa/assets/networking-dns.svg)

ì´ ì„¤ì •ì„ ê³ ë ¤í•˜ì‹­ì‹œì˜¤. ìš°ë¦¬ê°€ í•˜ê³ ì í•˜ëŠ” ê²ƒì€ IP ëŒ€ì‹  í˜¸ìŠ¤íŠ¸ Bë¥¼ ì£¼ì–´ì§„ ì´ë¦„ `db`ë¥¼ ì‚¬ìš©í•˜ì—¬ Aì—ì„œ í˜¸ìŠ¤íŠ¸ Bë¡œ í•‘í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

```bash
cat >> /etc/hosts
192.168.1.11 db
```

ì´ì œ `/etc/hosts`ëŠ” í˜¸ìŠ¤íŠ¸ Aì— ëŒ€í•œ ì§„ì‹¤ì˜ ì†ŒìŠ¤ì…ë‹ˆë‹¤. `/etc/hosts` íŒŒì¼ì—ì„œ ë¬´ì—‡ì„ ë³´ë“  ê·¸ê²ƒì´ ì§„ì‹¤ì´ë¼ê³  ìƒê°í•˜ê³  ê·¸ì— ë”°ë¼ ìš”ì²­ì„ ë³´ë‚´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ë¬¸ì œëŠ” `/etc/hosts` íŒŒì¼ì˜ í•­ëª©ì´ í•­ìƒ ì‚¬ì‹¤ì´ ì•„ë‹ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ í˜¸ìŠ¤íŠ¸ Bì—ì„œ `hostname` ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ í˜¸ìŠ¤íŠ¸ Bì˜ ì‹¤ì œ ì´ë¦„ì´ `host-2`ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ í˜¸ìŠ¤íŠ¸ AëŠ” ì´ ì‚¬ì‹¤ì„ ëª¨ë¥´ê¸° ë•Œë¬¸ì— `db` í˜¸ìŠ¤íŠ¸ì— ëŒ€í•œ ìš”ì²­ì´ ì˜¤ë©´ ëª¨ë“  ìš”ì²­ì„ í˜¸ìŠ¤íŠ¸ Bë¡œ ë‹¤ì‹œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.

ì´ë¥¼ ì´ë¦„ í™•ì¸ì´ë¼ê³  í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ì´ í”„ë¡œì„¸ìŠ¤ëŠ” í™•ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ 100ëŒ€ì˜ ì„œë²„ê°€ ìˆê³  ê·¸ ì¤‘ ìµœì†Œ 3ëŒ€ì˜ ì„œë²„ê°€ IPë¥¼ ì—…ë°ì´íŠ¸í–ˆë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € 100ê°œ ì„œë²„ ëª¨ë‘ì— ëŒ€í•´ `/etc/hosts` íŒŒì¼ì„ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  ì¼ë¶€ í˜¸ìŠ¤íŠ¸ IPê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ëª¨ë“  ì„œë²„ì— ëŒ€í•´ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì•¼ í•œë‹¤ê³  ê²Œì‹œí•´ì•¼ í•©ë‹ˆë‹¤. ì´ ëª¨ë“  í•­ëª©ì€ ì´ì œ DNS ì„œë²„ë¼ëŠ” íŠ¹ìˆ˜ ì„œë²„ë¡œ ì´ë™ë©ë‹ˆë‹¤.

í˜¸ìŠ¤íŠ¸ì— DNS ì„œë²„ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ `/etc/resolv.conf` íŒŒì¼ì— í•­ëª©ì„ ì¶”ê°€í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```bash
cat /etc/resolv.conf
nameserver   192.168.1.100

ping db
```

ì´ì œ ëª¨ë“  IP-í˜¸ìŠ¤íŠ¸ ì´ë¦„ í•­ëª©ì´ í˜¸ìŠ¤íŠ¸-IP ë³€ê²½ê³¼ í•¨ê»˜ í•œ ê³³ì—ì„œë§Œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ë”°ë¼ì„œ `/etc/hosts`ì— ëŒ€í•œ í•„ìš”ì„±ì´ ì œê±°ë˜ì–´ ê°œì¸ìš©ìœ¼ë¡œ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ DNS ì„œë²„ì™€ `/etc/hosts/` íŒŒì¼ì— 2ê°œì˜ ìœ ì‚¬í•œ í•­ëª©ì´ ìˆìœ¼ë©´ ì–´ë–»ê²Œ ë©ë‹ˆê¹Œ?

```bash
# DNS server entries
139.183.121.188   web
49.236.74.206   db
189.197.163.121   nfs
6.184.138.211   db-1
4.10.176.191   nfs-3
237.149.65.17   db-7
172.159.243.60   web-19
56.119.78.108   test   ğŸ‘ˆ
72.149.228.30   nfs-prod
27.48.22.70    sql
```

```bash
# /etc/hosts
192.168.1.115   test   ğŸ‘ˆ
```

ì—¬ê¸°ì—ì„œ ë¨¼ì € `/etc/hosts`ë¥¼ ë³¸ ë‹¤ìŒ DNS í•­ëª©ì„ ë´…ë‹ˆë‹¤.

ì´ì œ í˜¸ìŠ¤íŠ¸ Aì—ì„œ `netflix.com`ì„ pingí•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•©ë‹ˆê¹Œ?

Google DNSì— ëŒ€í•œ ìƒˆ í•­ëª©ì„ ë¡œì»¬ DNS ì„œë²„ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# DNS server entries
139.183.121.188   web
49.236.74.206   db
189.197.163.121   nfs
6.184.138.211   db-1
4.10.176.191   nfs-3
237.149.65.17   db-7
172.159.243.60   web-19
56.119.78.108   test   ğŸ‘ˆ
72.149.228.30   nfs-prod
27.48.22.70    sql

Forward All to 8.8.8.8
```

ë‹¤ìŒ ë ˆì½”ë“œê°€ ìˆëŠ” í˜¸ìŠ¤íŠ¸ Aì— ì—°ê²°ëœ ì¡°ì§ DNSê°€ ìˆë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```bash
# DNS server(192.168.1.100) entries
192.168.1.10   web.mycompany.com
192.168.1.11   db.mycompany.com
192.168.1.12   nfs.mycompany.com
192.168.1.13   web-1.mycompany.com
192.168.1.14   sql.mycompany.com
192.168.1.15   hr.mycompany.com
```

ì´ì œ 'web'ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ íŠ¸ë˜í”½ì„ 'web.mycompany.com'ìœ¼ë¡œ ë‹¤ì‹œ ë¼ìš°íŒ…í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ `/etc/resolv.conf`ì— í•­ëª©ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
cat /etc/resolv.conf
nameserver   192.168.1.100
search    mycompany.com
```

ì—¬ê¸°ì„œ ê²€ìƒ‰ í•­ëª©ì€ ëª¨ë“  ê²€ìƒ‰ í•­ëª©ì— `mycompany.com`ì„ ì¶”ê°€í•œ ë‹¤ìŒ DNSì—ì„œ ê²€ìƒ‰í•©ë‹ˆë‹¤.

ë˜í•œ 'ê²€ìƒ‰' í•„ë“œì˜ í•­ëª©ì€ ëˆ„ì ëœ í•­ëª© ì¤‘ í•˜ë‚˜ë¥¼ DNSì—ì„œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,

```bash
cat /etc/resolv.conf
nameserver   192.168.1.100
search    mycompany.com prod.mycompany.com
```

ê²€ìƒ‰ ê°€ëŠ¥í•œ í•­ëª©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. web.mycompany.com
2. web.prod.mycompany.com

### Record Types

| A     | web-server      | 192.168.1.1                       |
| ----- | --------------- | --------------------------------- |
| AAAA  | web-server      | fe80::e496:dacf:ecc7:62e2%9       |
| CNAME | food.web-server | eat.web-server, hungry.web-server |

### nslookup

ìœ„ì˜ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ê°œë³„ í˜¸ìŠ¤íŠ¸ì— ëŒ€í•´ ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸ë¥¼ pingí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ì—¬ê¸°ì„œ `/etc/hosts` íŒŒì¼ì˜ ê°œë³„ í˜¸ìŠ¤íŠ¸ í•­ëª©ì€ ì´ë¦„ í™•ì¸ì— ê³ ë ¤ë˜ì§€ ì•Šê³  DNSë§Œ ê³ ë ¤ë©ë‹ˆë‹¤.

```bash
nslookup www.google.com
Server:  dsldevice.lan
Address:  192.168.1.1

Non-authoritative answer:
Name:    www.google.com
Addresses:  2404:6800:4002:821::2004
          142.250.194.100
```

### dig

ìœ„ì˜ ëª…ë ¹ì€ ë” ë§ì€ ì •ë³´ê°€ ìˆëŠ” ê°œë³„ í˜¸ìŠ¤íŠ¸ì— ëŒ€í•´ ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸ë¥¼ pingí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

> ì—¬ê¸°ì„œ `/etc/hosts` íŒŒì¼ì˜ ê°œë³„ í˜¸ìŠ¤íŠ¸ í•­ëª©ì€ ì´ë¦„ í™•ì¸ì— ê³ ë ¤ë˜ì§€ ì•Šê³  DNSë§Œ ê³ ë ¤ë©ë‹ˆë‹¤.

```bash
dig www.google.com
```

## CoreDNS

### ì „ìš© ì‹œìŠ¤í…œì„ DNSë¡œ êµ¬ì„± - CoreDNS

1. curl ë˜ëŠ” wgetì„ ì‚¬ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ê·¸ê²ƒì„ ì¶”ì¶œí•˜ì‹­ì‹œì˜¤. coreDNS ì‹¤í–‰ íŒŒì¼ì„ ì–»ìŠµë‹ˆë‹¤.

   ```bash
   wget https://github.com/coredns/coredns/releases/download/v1.8.4/coredns_1.8.4_linux_arm64.tgz
   ```

   ```bash
   tar -xzvf coredns_1.8.4_linux_arm64.tgz
   ```

   ```bash
   ./coredns
   ```

2. ì‹¤í–‰ íŒŒì¼ì„ ì‹¤í–‰í•˜ì—¬ DNS ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. (ê¸°ë³¸ í¬íŠ¸ 53)

3. ì¼ë¶€ êµ¬ì„±ì„ ì œê³µí•´ì•¼ í•˜ëŠ” IP-í˜¸ìŠ¤íŠ¸ ì´ë¦„ ë§¤í•‘ì„ ì§€ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

   1. ì´ë¥¼ ìœ„í•´ ëª¨ë“  í•­ëª©ì„ DNS ì„œë²„ `/etc/hosts/` íŒŒì¼ì— ë„£ìŠµë‹ˆë‹¤.

4. ê·¸ëŸ° ë‹¤ìŒ í•´ë‹¹ íŒŒì¼ì„ ì‚¬ìš©í•˜ë„ë¡ CoreDNSë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. CoreDNSëŠ” `Corefile`ì´ë¼ëŠ” íŒŒì¼ì—ì„œ êµ¬ì„±ì„ ë¡œë“œí•©ë‹ˆë‹¤.
   ë‹¤ìŒì€ `/etc/hosts` íŒŒì¼ì—ì„œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ ë§¤í•‘ì— ëŒ€í•œ IPë¥¼ ê°€ì ¸ì˜¤ë„ë¡ CoreDNSì— ì§€ì‹œí•˜ëŠ” ê°„ë‹¨í•œ êµ¬ì„±ì…ë‹ˆë‹¤. DNS ì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ ì´ì œ ì„œë²„ì˜ `/etc/hosts/` íŒŒì¼ì—ì„œ IPì™€ ì´ë¦„ì„ ì„ íƒí•©ë‹ˆë‹¤.

## Network Namespaces

ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë˜ë©´ ì´ë¥¼ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ìì²´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œ ì»¨í…Œì´ë„ˆëŠ” ìì²´ ê°€ìƒ ë¼ìš°íŒ… ì¸í„°í˜ì´ìŠ¤, ë¼ìš°íŒ… í…Œì´ë¸” ë° ARP í…Œì´ë¸”ì„ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Creating network namespaces

2ê°œì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ `red` ë° `blue`ë¥¼ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```shell
ip netns add red
ip netns add blue
```

ì‹œìŠ¤í…œì— ìˆëŠ” ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë³´ë ¤ë©´

```bash
ip netns
```

### Exec in network namespaces

ëª¨ë“  ì¸í„°í˜ì´ìŠ¤ë¥¼ ë³´ë ¤ë©´

```shell
ip link
```

íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë³´ë ¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```shell
ip netns exec red ip link
# or
ip -n red link
```

> ê·¸ë˜ì„œ ì—¬ê¸°ì—ì„œ ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ í”¼ì¹­í•˜ëŠ” ê²ƒì„ ë°©ì§€í–ˆìŠµë‹ˆë‹¤.

íŠ¹ì • IP ì£¼ì†Œì— ëŒ€í•œ ARP í…Œì´ë¸”ì„ í‘œì‹œí•©ë‹ˆë‹¤. ë˜í•œ ARP ìºì‹œ ë˜ëŠ” í…Œì´ë¸”ì˜ ëª¨ë“  í•­ëª©ì„ í‘œì‹œí•©ë‹ˆë‹¤.

```shell
arp
```

íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì˜ ARP í•­ëª©ì— ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```shell
ip netns exec red arp
```

ë¼ìš°íŒ… í…Œì´ë¸” í•­ëª©ì„ í‘œì‹œí•˜ë ¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```shell
route
# for specific network
ip netns exec red route
```

ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ê¸°ë³¸ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### Connecting network interfaces

ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì— í•¨ê»˜ ì—°ê²°í•˜ë ¤ë©´ ê°€ìƒ ì¼€ì´ë¸” ë˜ëŠ” **íŒŒì´í”„**ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ì¸í„°í˜ì´ìŠ¤ê°€ 2ê°œì¸ ê°€ìƒ ì¼€ì´ë¸”)

ë¨¼ì € `veth-red` ë° `veth-blue`ë¼ëŠ” ë ì¸í„°í˜ì´ìŠ¤ê°€ ìˆëŠ” íŒŒì´í”„ë¥¼ ë§Œë“­ë‹ˆë‹¤.

```shell
ip link add veth-red type veth peer name veth-blue
```

ì´ì œ íŒŒì´í”„ì˜ ìµœì¢… ì¸í„°í˜ì´ìŠ¤ë¥¼ í•´ë‹¹ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.

```shell
ip link set veth-red netns red
ip link set veth-blue netns blue
```

ì´ì œ ê°ê°ì˜ **pipe-end-interface**-**network-namespace** ìŒì— IP ì£¼ì†Œë¥¼ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤.

```shell
ip -n red addr add 192.168.15.1 dev veth-red
ip -n blue addr add 192.168.15.2 dev veth-red
```

ì´ì œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™€ì•¼ í•©ë‹ˆë‹¤.

```shell
ip -n red link set veth-red up
ip -n blue link set veth-blue up
```

ì´ì œ red ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ IP<sub>blue</sub>ë¥¼ pingí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```shell
ip netns exec red ping 192.168.15.2
```

ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ARP í…Œì´ë¸”ì—ì„œë„ í•´ë‹¹ í•­ëª©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```shell
ip netns exec red arp
ip netns exec blue arp
```

> `blue` ë˜ëŠ” `red` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ê´€ë ¨í•˜ì—¬ ìœ ì‚¬í•œ í•­ëª©ì„ ì „í˜€ í‘œì‹œí•˜ì§€ ì•ŠëŠ” `arp`.

### ìƒí˜¸ í†µì‹ ì„ ìœ„í•œ ì—¬ëŸ¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™œì„±í™”

![](https://raw.githubusercontent.com/aditya109/learning-k8s//main/assets/multi-interface-inter-connection.png)

ì´ë¥¼ ìœ„í•´ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê°€ìƒ ìŠ¤ìœ„ì¹˜ì— ì—°ê²°í•˜ë©´ì„œ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ì™€ ê°€ìƒ ìŠ¤ìœ„ì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ë¨¼ì € `v-net-0`ì´ë¼ëŠ” `Linux Bridge`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸Œë¦¬ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ì˜ ê´€ì ì—ì„œ ë³´ë©´ ì¸í„°í˜ì´ìŠ¤ì™€ ì •í™•íˆ ìœ ì‚¬í•©ë‹ˆë‹¤.

```shell
ip link add v-net-0 type bridge
```

`ip link` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ DOWNì´ë¯€ë¡œ UPìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```shell
ip link set dev v-net-0 up
```

> To delete a virtual cable, we use:
>
> ```shell
> ip -n red link del veth-red
> ```

> ì—¬ê¸°ì„œ ì£¼ì˜í•  ì ì€ í•˜ë‚˜ì˜ pipe-end-interfaceë¥¼ ì‚­ì œí•˜ë©´ ë‹¤ë¥¸ í•˜ë‚˜ê°€ ì¦‰ì‹œ ì‚­ì œëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ìƒˆë¡œìš´ íŒŒì´í”„ê°€ í•„ìš”í•©ë‹ˆë‹¤.

```shell
ip link add veth-red type veth peer name veth-red-br
ip link add veth-blue type veth peer name veth-blue-br
```

ì´ì œ ë¸Œë¦¬ì§€ì™€ í•¨ê»˜ ìƒˆ íŒŒì´í”„ì— ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.

```shell
ip link set veth-red netns red
ip link set veth-red-br master v-net-0

ip link set veth-blue netns blue
ip link set veth-blue-br master v-net-0
```

ì´ì œ IP ì£¼ì†Œë¥¼ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì—°ê²°í•©ë‹ˆë‹¤.

```shell
ip -n red addr add 192.168.15.1 dev veth-red
ip -n blue addr add 192.168.15.1 dev veth-blue
```

ì´ì œ ê° ì¸í„°í˜ì´ìŠ¤ë¥¼ 'up'ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.

```shell
ip -n red link set veth-red up
ip -n blue link set veth-blue up
```

### í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œê³¼ ë¸Œë¦¬ì§€ ê°„ì˜ í†µì‹  í™œì„±í™”

![](https://github.com/aditya109/learning-k8s/blob/main/assets/host-interface-communication.jpg?raw=true)

ì´ë¥¼ ìœ„í•´ `v-net-0` ë¸Œë¦¬ì§€ì— IP ì£¼ì†Œë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.

```shell
ip addr add 192.168.15.5/24 dev v-net-0
```

Ping `192.168.15.5` from hostname.

```shell
ping 192.168.15.5
```

### ì™¸ë¶€ LAN ì—°ê²°ì— Linux Bridge ì—°ê²° í™œì„±í™” - 192.168.1.0

`blue` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì´ ì™¸ë¶€ IP `192.168.1.3`(ì™¸ë¶€ ë¼ìš°í„° `192.168.1.0`ì— ì—°ê²°ëœ)ì— ì§ì ‘ pingì„ ì‹œë„í•˜ë©´ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```shell
# ë¨¼ì € ê¸°ì¡´ ì—°ê²°ì— ëŒ€í•œ ë¼ìš°íŒ… í…Œì´ë¸”ì„ í™•ì¸í•©ë‹ˆë‹¤.
ip netns exec blue route

# ì™¸ë¶€ IP 192.168.1.3ì„ ì§ì ‘ í•‘í•˜ëŠ” í•´ë‹¹ IPì— ëŒ€í•œ ê´€ë ¨ í•­ëª©ì´ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ip netns exec blue ping 192.168.1.3
Connect: Network is unreachable
```

![](https://github.com/aditya109/learning-k8s/blob/main/assets/external-network-connection-to-namespace.jpg?raw=true)

**Solution:** ì™¸ë¶€ ë¼ìš°í„° '192.168.1.0'ì„ í†µí•´ ì™¸ë¶€ IP '192.168.1.3'ì„ pingí•´ì•¼ í•©ë‹ˆë‹¤.

```shell
ip netns exec blue ip router add 192.168.1.0/24 via 192.168.15.5

# ì´ì œ ì™¸ë¶€ IP 192.168.1.3ì„ pingí•˜ë©´
ip netns exec blue ping 192.168.1.3
PING 192.168.1.3 (192.168.1.3) 56(84) bytes of data.

# ê·¸ëŸ¬ë‚˜ ì™¸ë¶€ ë¼ìš°í„°ì— í˜¸ìŠ¤íŠ¸ IPê°€ ì—†ê¸° ë•Œë¬¸ì— ì‘ë‹µì„ ë°›ì§€ ëª»í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì—¬ê¸° ê²Œì´íŠ¸ì›¨ì´ì—ì„œ NATë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.
iptables -t nat -A POSTROUTING -s 192.168.15.0/24 -j MASQUERADE

# ì´ì œ ìš°ë¦¬ê°€ ì™¸ë¶€ ì„¸ê³„ë¥¼ í•‘í•  ë•Œ
ip netns exec blue ping 192.168.1.3
PING 192.168.1.3 (192.168.1.3) 56(84) bytes of data.
64 bytes from 192.168.1.3: icmp_seq=1 ttl=63 time=0.587 ms
64 bytes from 192.168.1.3: icmp_seq=1 ttl=63 time=0.466 ms
```

### ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì¸í„°ë„·ìœ¼ë¡œì˜ ì—°ê²°

```shell
ip netns exec blue ping 8.8.8.8
Connect: Network is unreachable

# ì´ìœ ëŠ” ë¼ìš°íŒ… í…Œì´ë¸” í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ip netns exec blue route

# ê¸°ë³¸ ë¼ìš°íŒ… í•­ëª© ì¶”ê°€
ip netns exec blue ip route add default via 192.168.15.5

# ì§€ê¸ˆ í•‘í•˜ë©´ ì‘ë™í•©ë‹ˆë‹¤
ip netns exec blue ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=0.587 ms
64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=0.466 ms
```

### ì¸í„°ë„·ì—ì„œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œì˜ ì—°ê²°

```shell
ping 192.168.15.2
Connect: Network is unreachable
```

í•œ ê°€ì§€ ë°©ë²•ì€ í˜¸ìŠ¤íŠ¸ IPë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë„ë‹¬í•  ìˆ˜ ìˆì§€ë§Œ ë¼ìš°íŒ… ì„¤ì •ì„ ì œê³µí•˜ë¯€ë¡œ ì•ˆì „í•˜ì§€ ì•Šë‹¤ëŠ” ê²ƒì„ ì•Œë ¤ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë‘ ë²ˆì§¸ ë°©ë²•ì€ IPTABLE ë¼ìš°íŒ… êµ¬ì„±ì„ ì„¤ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

```shell
iptables -t nat -a PREROUTING --dport 80 --to-destination 192.168.15.2:80 -j DNAT
```

> **Notes:**
>
> 1. ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë™ì•ˆ í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ pingí•  ìˆ˜ ì—†ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ë©´ IP ì£¼ì†Œë¥¼ ì„¤ì •í•˜ëŠ” ë™ì•ˆ NETMASKë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì¦‰: `192.168.1.10/24`
>
>    ```shell
>    ip -n red addr add 192.168.1.10/24 dev veth-red
>    ```
>
> 2. í™•ì¸í•´ì•¼ í•  ë˜ ë‹¤ë¥¸ ì‚¬í•­ì€ ë°©í™”ë²½ D/IP í…Œì´ë¸” ê·œì¹™ì…ë‹ˆë‹¤. í•˜ë‚˜ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œì˜ íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ë„ë¡ IP í…Œì´ë¸”ì— ê·œì¹™ì„ ì¶”ê°€í•˜ì‹­ì‹œì˜¤. ë˜ëŠ” IP í…Œì´ë¸”ì„ ëª¨ë‘ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤(í•™ìŠµ í™˜ê²½ì—ì„œë§Œ).

## Docker Networking

Dockerê°€ ì„¤ì¹˜ëœ ë‹¨ì¼ ì„œë²„ë¥¼ ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ëœ IPê°€ '192.168.1.10'ì¸ 'eth0' ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ëŠ” ë™ì•ˆ ë‹¤ìŒ ë„¤íŠ¸ì›Œí¬ ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. `docker run --network none nginx`
   ì—¬ê¸°ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆëŠ” ì–´ë–¤ ë„¤íŠ¸ì›Œí¬ì—ë„ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë“¤ì–´ì˜¤ê³  ë‚˜ê°€ëŠ” ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤. ì´ê²ƒì€ ì™„ì „í•œ _ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬_ì…ë‹ˆë‹¤.

2. `docker run --network host nginx`

ì—¬ê¸°ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆëŠ” í¬íŠ¸ **80**ì˜ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë©ë‹ˆë‹¤. ì¦‰, í¬íŠ¸ 80ì—ì„œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” URI `https://192.168.1.10:80`ì—ì„œ ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   > ì´ëŸ¬í•œ ì»¨í…Œì´ë„ˆì˜ ì¸ìŠ¤í„´ìŠ¤ëŠ” í•˜ë‚˜ë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©° í•˜ë‚˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ ë™ì‹œì— í¬íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

3. `docker run nginx`

ì—¬ê¸°ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆëŠ” ê° ì»¨í…Œì´ë„ˆê°€ ê³ ìœ í•œ ê°œì¸ IPë¥¼ ê°–ëŠ” ë¸Œë¦¬ì§€ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë©ë‹ˆë‹¤.

   DockerëŠ” ì´ ë„¤íŠ¸ì›Œí¬ë¥¼ `docker network ls`ì˜ ì¶œë ¥ì— í‘œì‹œë˜ëŠ” ì´ë¦„ì¸ `bridge`ë¡œ ìƒì„±í•˜ì§€ë§Œ í˜¸ìŠ¤íŠ¸ì—ì„œ ìƒì„±ëœ ë„¤íŠ¸ì›Œí¬ ì´ë¦„ì€ `docker0`(`ip link`ì˜ ì¶œë ¥ì— í‘œì‹œë¨)ì…ë‹ˆë‹¤. ).

   ë”°ë¼ì„œ `docker0`ê³¼ `bridge`ëŠ” í•˜ë‚˜ì´ë©° ë™ì¼í•œ ê²ƒì…ë‹ˆë‹¤.

   `docker0`ì—ëŠ” `ip addr` ëª…ë ¹ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆëŠ” IPê°€ ë¶€ì—¬ë©ë‹ˆë‹¤. `ip link`ëŠ” `docker0` ì¸í„°í˜ì´ìŠ¤ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìš´ë˜ì—ˆìŒì„ ì•Œë ¤ì¤ë‹ˆë‹¤. DockerëŠ” ë˜í•œ ì´ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. `ip netns`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**DockerëŠ” ì»¨í…Œì´ë„ˆë¥¼ ë¸Œë¦¬ì§€ ë„¤íŠ¸ì›Œí¬ì— ì–´ë–»ê²Œ ì—°ê²°í•©ë‹ˆê¹Œ?**

ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë  ë•Œë§ˆë‹¤ DockerëŠ” ì»¨í…Œì´ë„ˆì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. Dockerê°€ ìƒì„±í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” `ip netns` ëª…ë ¹(ì•½ê°„ ìˆ˜ì •ëœ ë²„ì „)ì„ ì‚¬ìš©í•˜ì—¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`ip netns exec "${container_id}" ip -s link show eth0`

![](https://github.com/aditya109/learning-k8s/blob/main/assets/docker-networking.png?raw=true)

DockerëŠ” ê°€ìƒ ì¼€ì´ë¸”ì„ ìƒì„±í•˜ê³  í•œìª½ ëì„ Dockerì˜ ë¸Œë¦¬ì§€ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°í•˜ê³  ë‹¤ë¥¸ ìª½ ëì€ ì»¨í…Œì´ë„ˆ ìì²´ì— ì—°ê²°í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´,

```bash
ip netns
b3165c10a92b
```

ê·¸ëŸ° ë‹¤ìŒ `ip link`ë¥¼ ì‚¬ìš©í•˜ë©´ ì¶œë ¥ì— `vethbb1c343@if7`ì´ í‘œì‹œë©ë‹ˆë‹¤.

ë˜í•œ ê°€ìƒ ì¼€ì´ë¸”ì˜ ë‹¤ë¥¸ ìª½ ëì€ ë™ì¼í•œ 'ip link' ëª…ë ¹ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
ip -n b3165c10a92b link
eth0@if8
```

ì»¨í…Œì´ë„ˆì—ëŠ” `ip addr`ë¡œ ë³¼ ìˆ˜ ìˆëŠ” ë³„ë„ì˜ IPê°€ í• ë‹¹ë©ë‹ˆë‹¤.

```bash
ip -n b3165c10a92b addr
```

ë™ì¼í•œ í”„ë¡œì„¸ìŠ¤ê°€ ì—¬ëŸ¬ ë²ˆ ë°˜ë³µë©ë‹ˆë‹¤.

ë¸Œë¦¬ì§€ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ëœ ìƒíƒœì—ì„œ ì»¨í…Œì´ë„ˆê°€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í˜¸ìŠ¤íŒ…í•˜ëŠ” ê²½ìš° í¬íŠ¸ **80**ì—ì„œ ë„ì»¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì§€ë§Œ í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ì„œëŠ” í¬íŠ¸ë¥¼ ê²Œì‹œí•´ì•¼ í•©ë‹ˆë‹¤.

`docker run --publish HOST_PORT:CONTAINER_PORT <container-name>`

**Dockerì˜ IP ê·œì¹™ì„ ë³´ëŠ” ë°©ë²• ?**

```shell
iptables -nvL -t nat
Chain Docker (2 references)
```

| target | prot | opt | source   | destination |                                |
| ------ | ---- | --- | -------- | ----------- | ------------------------------ |
| RETURN | all  | --  | anywhere | anywhere    |                                |
| DNAT   | tcp  | --  | anywhere | anywhere    | tcp dpt:8080 to :172.17.0.2:80 |

## CNI

**_Container Runtime_**

1. ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±

**_Bridge_** `bridge add <cid> <namespaceid>`

2. Create Bridge Network/Interface
3. Create VETH Pairs (pipes)
4. Attach pipes to Namespaces
5. Attach pipes to Bridge
6. Assign IP addresses
7. Bring the interfaces up
8. Enable NAT -IP Masquerade

### ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ìš© CNI ì§€ì‹œì–´

- Container Runtimeì€ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
- ì»¨í…Œì´ë„ˆê°€ ì—°ê²°í•´ì•¼ í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.
- ì»¨í…Œì´ë„ˆ ì¶”ê°€ ì‹œ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸(ë¸Œë¦¬ì§€)ì„ í˜¸ì¶œí•˜ëŠ” ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„.
- ì»¨í…Œì´ë„ˆê°€ ì‚­ì œë  ë•Œ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸(ë¸Œë¦¬ì§€)ì„ í˜¸ì¶œí•˜ëŠ” ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„.
- ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ì˜ JSON í˜•ì‹.

Examples, Kubernetes, rkt, Mesos, etc.

> Dockerê°€ CNIë¥¼ ë”°ë¥´ì§€ ì•ŠëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?
>
> ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ëª¨ë¸(CNM)ì´ë¼ëŠ” ìì²´ ë„¤íŠ¸ì›Œí‚¹ ì¸í„°í˜ì´ìŠ¤ í‘œì¤€ì´ ìˆìŠµë‹ˆë‹¤.

### ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì— ëŒ€í•œ CNI ì§€ì‹œì–´

- ëª…ë ¹ì¤„ ì¸ìˆ˜ ADD/DEL/CHECKë¥¼ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤.
- ë§¤ê°œë³€ìˆ˜ ì»¨í…Œì´ë„ˆ ID, ë„¤íŠ¸ì›Œí¬ ns ë“±ì„ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤.
- PODì— ëŒ€í•œ IP ì£¼ì†Œ í• ë‹¹ì„ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
- íŠ¹ì • í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

Examples, Bridge, VLAN, IPVLAN, MACVLAN, WINDOWS, DHCP, host-local.

Also, `weaveworks`, `flannel`, `cilium`, `vmwareNSX`, etc.

## Cluster Networking

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/cluster-networking.svg)

í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ëª‡ ê°€ì§€ ì „ì œ ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤.

1. ê° ë…¸ë“œì—ëŠ” IP, ë…¸ë“œ ì´ë¦„ ë° MAC ì£¼ì†Œê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
2. ì¼ë¶€ í¬íŠ¸ëŠ” ë…¸ë“œì—ì„œë„ ì—´ë ¤ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/mandatory-port-openings-on-node.png)

![](https://raw.githubusercontent.com/aditya109/learning-k8s/main/assets/mandatory-port-openings-on-master-node.png)

**Master node(s)-**

| Protocol | Direction | Port Range | Purpose                 | Used by              |
| -------- | --------- | ---------- | ----------------------- | -------------------- |
| TCP      | Inbound   | 6443\*     | Kubernetes API server   | All                  |
| TCP      | Inbound   | 2379-2380  | etcd server client API  | kube-apiserver, etcd |
| TCP      | Inbound   | 10250      | Kubelet API             | Self, control plane  |
| TCP      | Inbound   | 10251      | kube-scheduler          | Self                 |
| TCP      | Inbound   | 10252      | kube-controller manager | Self                 |

**Worker node(s)-**

| Protocol | Direction | Port Range  | Purpose               | Used by             |
| -------- | --------- | ----------- | --------------------- | ------------------- |
| TCP      | Inbound   | 10250       | Kubernetes API        | Self, control plane |
| TCP      | Inbound   | 30000-32767 | NodePort Services\*\* | All                 |

**í´ëŸ¬ìŠ¤í„°ì˜ ë„¤íŠ¸ì›Œí‚¹ ë¬¸ì œ ë””ë²„ê¹…ì„ ìœ„í•œ í¸ë¦¬í•œ ëª…ë ¹**

```shell
ip link
```

```shell
ip addr
```

```shell
ip addr add 192.168.1.10/24 dev eth0
```

```shell
ip route
```

```shell
ip route add 192.168.1.10/24 via 192.168.2.1
```

```shell
cat /proc/sys/net/ipv4/ip_forward
1
```

```shell
arp
```

```shell
netstat -plnt
```

**ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ í´ëŸ¬ìŠ¤í„° ì—°ê²°ì„ ìœ„í•´ êµ¬ì„±ëœ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?**

```shell
kubectl get nodes -o wide | grep controlplane

controlplane   Ready    control-plane,master   9m47s   v1.20.0   10.27.140.6   <none>        Ubuntu 18.04.5 LTS   5.4.0-1052-gcp   docker://19.3.0

# copy internal ip from there

ip a | grep -B2 10.27.140.6
7180: eth0@if7181: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default
    link/ether 02:42:0a:1b:8c:06 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.27.140.6/24 brd 10.27.140.255 scope global eth0

# eth0 is the network interface
```

**node01ì˜ MAC ì£¼ì†ŒëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?**

```shell
arp node01
Address                  HWtype  HWaddress           Flags Mask            Iface
10.27.140.8              ether   02:42:0a:1b:8c:07   C                     eth0
```

**ê¸°ë³¸ ê²Œì´íŠ¸ì›¨ì´ì˜ IP ì£¼ì†ŒëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?**

```shell
ip route show default
default via 172.17.0.1 dev eth1
```

**ETCDëŠ” ë‘ ê°œì˜ í¬íŠ¸ì—ì„œ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ë‹¤ìŒ ì¤‘ ë” ë§ì€ í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²ƒì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?**

```shell
netstat -anp | grep etcd | grep PORT_NUMBER | wc -l
```

## Kubernetes ë„¤íŠ¸ì›Œí‚¹ ëª¨ë¸ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•

[Creating Highly Available clusters with kubeadm | Kubernetes](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/#steps-for-the-first-control-plane-node)
