## kube-config

ì‚¬ìš©ìëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ìœ¼ë¡œ `kube-apiserver`ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. Using `cURL` command -

   ```bash
   > curl https://my-kube-playground:6443/api/v1/pods \
   --key admin.key
   --cert admin.crt
   --cacert ca.crt
   
   {
   	"kind" : "PodList",
   	"apiVersion": "v1",
   	"metadata": {
   		"selfLink": "/api/v1/pods",
   	},
   	"items": []
   }
   ```

2. Using `kubectl` command - 

   ```bash
   > kubectl get pods \
   			--server my-kube-playground:6443
   			--client-key admin.key
   			--client-certificate admin.crt
   			--certificate-authority ca.crt
   No resources found.
   ```

3. Using `kube-config` file:

   ```yaml
   # $HOME/.kube/config
   ```

   The `kube-config` file has 3 sections:

   | Sections | Description                                                  | Examples                                 | Remark relating to above command                             |
   | -------- | ------------------------------------------------------------ | ---------------------------------------- | ------------------------------------------------------------ |
   | Clusters | They are various Kubernetes clusters                         | Development, Production, Staging, etc.   | --server                                                     |
   | Users    | They are various interacting users with multiple types of privileges | Admin, Dev user, Prod user, etc.         | --client-key admin.key,		<br />--client-certificate admin.crt,<br />--certificate-authority ca.crt |
   | Contexts | They create a symbolic relationship                          | Admin@Production, Prod user@Google, etc. | Cluster@User                                                 |

   ```yaml
   # kube-config.yaml
   apiVersion: v1
   kind: Config
   
   clusters:
   - name: my-kube-playground
     cluster:
       certificate-authority:
       server: https://my-kube-playground:6443
   
   contexts:
   - name: my-kube-admin@my-kube-playground
     context:
       cluster: my-kube-playground
       user: my-kube-admin
   
   users:
   - name: my-kube-admin
     user:
       client-certificate: admin.crt
       client-key: admin.key
   ```

   ê¸°ë³¸ì ìœ¼ë¡œ `kubectl` ìœ í‹¸ë¦¬í‹°ëŠ” `$HOME/.kube/config` ê²½ë¡œë¥¼ ì°¾ìŠµë‹ˆë‹¤.

   ```bash
   > kubectl get pods
   	--kubeconfig config
   ```
   
   ```yaml
   # kube-config.yaml
   apiVersion: v1
   kind: Config
   
   current-context: dev-user@google # specifies the current context
   
   clusters:
   - name: my-kube-playground
     # (values hidden)
   - name: development
     # (values hidden)
   - name: production
     # (values hidden)
   - name: my-kube-playground
     # (values hidden)
     
   contexts:
   - name: my-kube-admin@my-kube-playground
     # (values hidden)
   - name: dev-user@google
     # (values hidden)
   - name: prod-user@production
     # (values hidden)
   
   users:
   - name: my-kube-admin
     # (values hidden)
   - name: admin
     # (values hidden)
   - name: dev-user
     # (values hidden)  
   - name: prod-user
     # (values hidden)
   ```
   
   > `current-context`ëŠ” ì‚¬ìš© ì¤‘ì¸ í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
   
   `kube-config`ë¥¼ ë³´ë ¤ë©´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
   
   ```bash
   > kubectl config view
   apiVersion: v1
   clusters:
   - cluster:
       certificate-authority-data: DATA+OMITTED
       server: https://kubernetes.docker.internal:6443
     name: docker-desktop
   contexts:
   - context:
       cluster: docker-desktop
       user: docker-desktop
     name: docker-desktop
   current-context: docker-desktop
   kind: Config
   preferences: {}
   users:
   - name: docker-desktop
     user:
       client-certificate-data: REDACTED
       client-key-data: REDACTED
   ```
   
   ì‚¬ìš©ì ì§€ì • kube-config íŒŒì¼ì„ ë³´ë ¤ë©´ ë™ì¼í•œ ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
   
   ```bash
   kubectl config view --kubeconfig=my-custom-config
   ```
   
   To change `current-context`, we use:
   
   ```bash
   kubectl config use-context prod-user@production
   ```
   
   ### ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©
   
   ```yaml
   # kube-config-04.yaml
   apiVersion: v1
   kind: Config
   
   clusters:
   - name: production
     cluster:
       certificate-authority: /etc/kubernetes/pki/ca.crt
       server: https://172.17.0.51:6443
   
   contexts:
   - name: admin@production
     context:
       cluster: production
       user: admin
       namespace: finance
   
   users:
   - name: admin
     user:
       client-certificate:  /etc/kubernetes/pki/users/admin.crt
       client-key: /etc/kubernetes/pki/users/admin.key
   ```
   
   ### kube-configsì—ì„œ ì¸ì¦ì„œì˜ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ì œê³µ
   
   ```yaml
   # kube-config-04.yaml
   apiVersion: v1
   kind: Config
   
   clusters:
   - name: production
     cluster:
       certificate-authority-data:
       # paste the base64 encoded the certificate data here 
       server: https://172.17.0.51:6443
   
   contexts:
   - name: admin@production
     context:
       cluster: production
       user: admin
       namespace: finance
   
   users:
   - name: admin
     user:
       client-certificate-data:  # Base64ë¡œ ì¸ì½”ë”©ëœ ì¸ì¦ì„œ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì‹­ì‹œì˜¤.
       client-key-data:  # base64ë¡œ ì¸ì½”ë”©ëœ í‚¤ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
   ```
   
   

## Persistent Key/Value Store

## API Groups

kubernetes API ì„œë²„ëŠ” `cURL` ëª…ë ¹ì„ í†µí•´ ì¿¼ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Example 1:

```bash
> curl https://kubernetes.docker.internal:6443/version
```

```json
Client Version: version.Info{Major:"1", Minor:"21", GitVersion:"v1.21.2", GitCommit:"092fbfbf53427de67cac1e9fa54aaa09a28371d7", GitTreeState:"clean", BuildDate:"2021-06-16T12:59:11Z", GoVersion:"go1.16.5", Compiler:"gc", Platform:"windows/amd64"}
Server Version: version.Info{Major:"1", Minor:"21", GitVersion:"v1.21.1", GitCommit:"5e58841cce77d4bc13713ad2b91fa0d961e69192", GitTreeState:"clean", BuildDate:"2021-05-12T14:12:29Z", GoVersion:"go1.16.4", Compiler:"gc", Platform:"linux/amd64"}
```

Example 2:

```bash
> curl --location --request GET 'https://kubernetes.docker.internal:6443/api/v1/pods' \
--header 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im1GLTlBNGg1VEJBQVF1bWQ4cTRQX2hiUGpHUTlMdVo4U3VtTUVhb0FVSm8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tbmQ1dmciLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjkwNWQwZGQyLWYyNjgtNGYxNC05ZWM0LTEwY2JlYjE5Njc5OCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.XXWWArytFl8S5511VrGhTLp7r5MEKoowjFYl1jcuC2nCG7HTfDwNycjuJK2Bf4A6c-iwhkS1HxGtnVnUqeg2Lho6lCkfRuHJflkN_KYhTBh2FeE95gjZ7hpBkCLeK5A91hDJ7tVtyJe2QyLI58g2JFMvRMENIIsbr3W66bDrMmnLW1uxKLO3lDoC3YXYMJO1n9HREhcltqi_d3ljwF5JOK7XPtT7aFMUTzHUcsURN5u1bbeYJTir-fg8LaQ8DPFFxsRv1BvFzRalMgho8Gz1InOO1CPJWs9gRot7BuKQKsdCxVLiIsKn4K2Pv8z85SFI2FKSGzFvD_lNV71ZnV9YTA'
```

ì´ëŸ¬í•œ APIëŠ” 6ê°€ì§€ ë²”ì£¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.

1. `/metrics`
2. `/healthz`
3. `/version`
4. `/api`  ğŸ‘ˆ
5. `/apis` ğŸ‘ˆ
6. `/logs`

`/api`ëŠ” ìì²´ì ìœ¼ë¡œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨í•˜ëŠ” Core API ì§‘í•©ì…ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/api%20distribution.png?raw=true)

`/apis`ëŠ” ë³´ë‹¤ ì²´ê³„í™”ëœ ëª…ëª…ëœ ê·¸ë£¹ API ì§‘í•©ì…ë‹ˆë‹¤.

### kubectl proxy

`kube-apiserver`ë¥¼ ëˆ„ë¥´ê¸° ìœ„í•œ `curl` ì™¸ì—ë„ apiserverë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ `kubectl proxy`ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

`kubectl proxy`ë¥¼ ì‹¤í–‰í•˜ì—¬ apiserverë¥¼ í˜¸ì¶œí•˜ì‹­ì‹œì˜¤. í¬íŠ¸ 8080 ë˜ëŠ” `http://127.0.0.1:8080`ì—ì„œ í”„ë¡ì‹œë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ë™ì¼í•œ ì‘ë‹µì„ ì–»ê¸° ìœ„í•´ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì´ í”„ë¡ì‹œë¥¼ ì ì¤‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


## Authorization

Kubernetesì—ì„œ ì§€ì›í•˜ëŠ” ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜:

- Node
- ABAC
- RBAC
- Webhook
- AlwaysAllow (no authorization, allows all requests)
- AlwaysDeny (no authorization, denies all requests)

### Node-based Authorization

ì¼ë°˜ì ì¸ Kubernetes ì„¤ì •ì—ì„œ ì‚¬ìš©ìëŠ” `kube-apiserver`ì— ìš”ì²­ì„ ë³´ë‚´ê³  `kubelet`ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ìš”ì²­ì— ëŒ€í•œ ëª¨ë“  ê¶Œí•œ ë¶€ì—¬ëŠ” 'Node Authorizer'ë¼ëŠ” íŠ¹ìˆ˜ ì—”í‹°í‹°ì— ì˜í•´ ì²˜ë¦¬ë©ë‹ˆë‹¤.

`kubelet`ì´ ë³´ë‚¸ ëª¨ë“  ìš”ì²­ì€ `system:node:node01`ì´ë¼ëŠ” ê·¸ë£¹ ì´ë¦„ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©° `system:node:node01` ê·¸ë£¹ì˜ ì¼ë¶€ì…ë‹ˆë‹¤. `system:node:node01` ê·¸ë£¹ì—ì„œ ì˜¤ëŠ” ëª¨ë“  ìš”ì²­ì€ `Node Authorizer`ì— ì˜í•´ ìŠ¹ì¸ë©ë‹ˆë‹¤.

### Attribute Based Access Control-ABAC

ABAC(`/api`ì— ëŒ€í•œ ì™¸ë¶€ ì•¡ì„¸ìŠ¤ìš©)ì—ì„œ ì‚¬ìš©ì ë˜ëŠ” ì‚¬ìš©ì ì§‘í•©ì„ ê¶Œí•œ ì§‘í•©ì— ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ JSON í˜•ì‹ìœ¼ë¡œ ì–¸ê¸‰ëœ ì •ì±… ëª©ë¡ìœ¼ë¡œ `Policy` ì •ì˜ íŒŒì¼ì„ ìƒì„±í•˜ê³  `kube-apiserver`ë¡œ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.

```json
{
    "kind": "Policy",
    "spec": {
        "user": "dev-user",
        "namespace": "*",
        "resource": "pods",
        "apiGroup": "*"
    }
}
```

'Policy' ì •ì˜ íŒŒì¼ì„ ì‚¬ìš©í•  ë•Œì˜ ë¬¸ì œëŠ” ê¶Œí•œì„ í¸ì§‘í•  ë•Œë§ˆë‹¤ ê´€ë¦¬ìê°€ ì•ì„œ ì–¸ê¸‰í•œ ì •ì±… ì •ì˜ íŒŒì¼ì—ì„œ ë™ì¼í•œ ê¶Œí•œì„ ìˆ˜ë™ìœ¼ë¡œ ë¶€ì—¬í•˜ê±°ë‚˜ ì·¨ì†Œí•´ì•¼ í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

### Webhook

í•˜ì§€ë§Œ ìŠ¹ì¸ì„ ì•„ì›ƒì†Œì‹±í•´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í•©ë‹ˆê¹Œ? ì˜ˆë¥¼ ë“¤ì–´ ê¸°ë³¸ ì œê³µ í•­ëª©ì„ ì‚¬ìš©í•˜ê³  ì‹¶ì§€ ì•ŠìŠµë‹ˆë‹¤.

- `Open Policy Agent`

ë”°ë¼ì„œ ì‚¬ìš©ìë¡œë¶€í„° ìš”ì²­ì„ ë°›ìœ¼ë©´ `kube-apiserver`ëŠ” ì‚¬ìš©ìê°€ ìš”ì²­ì„ í•  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” `Open Policy Agent`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

### Role Based Access Control-RBAC

RBACì—ì„œëŠ” ë¨¼ì € 'Role'ì„ ë§Œë“  ë‹¤ìŒ 'Role'ì— ê¶Œí•œì„ ì—°ê²°í•˜ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ í•´ë‹¹ ì—­í• ì— ì—°ê²°í•©ë‹ˆë‹¤.

ë¨¼ì € `Role` ì •ì˜ íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

```yaml
# dev-role.yaml
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["list", "get", "create", "update", "delete"]
  - apiGroups: [""]
    resources: ["ConfigMap"]
    verbs: ["create"]
```

ê·¸ëŸ° ë‹¤ìŒ `RoleBinding` ì •ì˜ íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

```yaml
# devuser-dev-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: devuser-dev-binding
subjects:
  - kind: User
    name: dev-user
    apiGroup: rbac.authorization.k8s.io
roleRef:
  - kind: Role
    name: developer
    apiGroup: rbac.authorization.k8s.io
```

ì—­í•  ë° ì—­í•  ê²°í•©ì„ ë‚˜ì—´í•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```powershell
> kubectl get roles 
> kubectl get rolebindings
```

ìì„¸íˆ ë³´ë ¤ë©´,

```powershell
$ kubectl describe role developer
Name:         developer
Labels:       <none>
Annotations:  <none>
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  ConfigMap  []                 []              [create]
  pods       []                 []              [list get create update delete]
  
$ kubectl describe rolebinding devuser-dev-binding
Name:         devuser-dev-binding
Labels:       <none>
Annotations:  <none>
Role:
  Kind:  Role
  Name:  developer
Subjects:
  Kind  Name      Namespace
  ----  ----      ---------
  User  dev-user
```

#### Check Access

íŠ¹ì • kubectl ëª…ë ¹ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```powershell
$ kubectl auth can-i create deployments
yes
```

ë‹¤ë¥¸ ì‚¬ìš©ìê°€ íŠ¹ì • kubectl ëª…ë ¹ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. (ê´€ë¦¬ìì— ì˜í•´)

```powershell
$ kubectl auth can-i create deployments \
	--as developer \
	--namespace default 
no
```

#### Restrictive Access

ì—­í•  ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— `resourceNames` í•„ë“œë¥¼ ì œê³µí•˜ì—¬ ì¼ë¶€ í¬ë“œë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì‚¬ìš©ìë¥¼ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yaml
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["list", "get", "create", "update", "delete"]
    resourceNames: ["blue", "orange"]		
  - apiGroups: [""]
    resources: ["ConfigMap"]
    verbs: ["create"]
```

### kube-apiserver and Authorization Modes

ê¶Œí•œ ë¶€ì—¬ ëª¨ë“œë¥¼ êµ¬ì„±í•˜ë ¤ë©´ `kube-apiserver` ì„œë²„ ìƒì„± ì‹œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/authmode.png?raw=true)

ì—¬ê¸°ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆìœ¼ë©° ì—¬ëŸ¬ ëª¨ë“œë¥¼ ë™ì¼í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¸ì¦ ìˆœì„œëŠ” íŒŒì¼ì— ì–¸ê¸‰ëœ ê²ƒê³¼ ë™ì¼í•©ë‹ˆë‹¤.

![](https://github.com/aditya109/learning-k8s/blob/main/assets/authmode2.png?raw=true)

ì—¬ê¸°ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ ìš”ì²­ì€ ë¨¼ì € Node Authorizerì— ì˜í•´ ìŠ¹ì¸ë©ë‹ˆë‹¤. ëª¨ë“ˆì´ ìš”ì²­ì„ ê±°ë¶€í•˜ë©´ ìš”ì²­ì´ ëª©ë¡ì˜ ë‹¤ìŒ ë§í¬(ì—¬ê¸°ì„œëŠ” RBAC, Webhook)ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.

## Cluster Roles and Cluster Role Bindings

`RoleBinding` ë° `Role`ì€ ***ë„¤ì„ìŠ¤í˜ì´ìŠ¤***ì´ë©° ë‹¤ìŒê³¼ ê°™ì€ ***í´ëŸ¬ìŠ¤í„° ë²”ìœ„*** ë¦¬ì†ŒìŠ¤ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

- nodes
- PV
- clusterroles
- clusterrolebindings
- certificatesigningrequests
- namespaces

```powershell
# ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¦¬ì†ŒìŠ¤ ëª©ë¡ì„ ê°€ì ¸ì˜¤ë ¤ë©´
kubectl api-resources --namespaced=true
# í´ëŸ¬ìŠ¤í„° ë²”ìœ„ ë¦¬ì†ŒìŠ¤ ëª©ë¡ì„ ê°€ì ¸ì˜¤ë ¤ë©´
kubectl api-resources --namespaced=false
```

í´ëŸ¬ìŠ¤í„° ë²”ìœ„ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µ/ì·¨ì†Œí•˜ê¸° ìœ„í•´ í´ëŸ¬ìŠ¤í„° ì—­í• ì„ ìƒì„±í•©ë‹ˆë‹¤.

```yaml
# cluster-admin-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-administrator
rules:
- apiGroups: [""]
  resources:
    - nodes
  verbs: 
  - list
  - get
  - create
  - delete
```

```bash
$ kubectl create -f .\cluster-admin-role.yaml
clusterrole.rbac.authorization.k8s.io/cluster-administrator created
```

ì‚¬ìš©ìë¥¼ clusterroleì— ì—°ê²°í•˜ê¸° ìœ„í•´ clusterrolebindingì„ ìƒì„±í•©ë‹ˆë‹¤.

```yaml
# cluster-admin-role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-admin-role-binding
subjects:
- kind: User
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-administrator
```
